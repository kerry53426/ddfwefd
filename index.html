
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ„›ä¸Šå–œç¿ | å±±æ—æ‹¾å…‰æ”¶é›†å†Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --color-mountain: #2C3E50;
            --color-gold: #B8860B;
            --color-gold-light: #D4AF37;
            /* Improved Glass Vars */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
        }

        body {
            font-family: 'Noto Serif TC', serif;
            color: var(--color-mountain);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            background-image: url('https://i.ibb.co/23KWDLjy/597488410-25468436916138867-3479504377125617703-n.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-color: #1a202c; /* Fallback dark color */
            transition: background-color 0.8s ease;
        }

        /* 1. Background Contrast: Dark Overlay */
        .bg-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: rgba(0, 0, 0, 0.35); /* Darkened for luxury contrast */
            backdrop-filter: blur(2px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scenic-mode .bg-overlay {
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
        }

        /* 2. Luxury Glass Container */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); /* Stronger blur */
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            border-radius: 1.5rem; /* rounded-3xl */
        }

        /* 3. Grid Cells Polish - Polaroid / Aged Paper Style */
        .memory-frame {
            aspect-ratio: 1;
            /* Paper/Card Look */
            background-color: #FDFBF7; /* Cream/Off-white */
            border: 4px solid #FFFFFF; /* Polaroid Frame */
            border-radius: 0.25rem; /* rounded-sm */
            
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            /* Shadow-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Interactive State (Hover/Active) */
        .memory-frame:not(.collected):active,
        .memory-frame:not(.collected):hover {
            transform: translateY(-4px); /* Lift up */
            /* Shadow-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 10;
        }

        /* --- PURE CSS "WUFENG STARRY NIGHT" STYLE --- */
        .memory-frame.collected {
            /* Base Sky Gradient */
            background: linear-gradient(to bottom, #1e1b4b, #312e81); /* Indigo-950 to Indigo-900 */
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
            z-index: 5;
        }

        /* Layer 1: Stars (Using box-shadow trick) */
        .memory-frame.collected::before {
            content: "";
            position: absolute;
            top: 5%; left: 5%;
            width: 2px; height: 2px;
            background: white;
            border-radius: 50%;
            /* Creating multiple stars via shadow offsets */
            box-shadow: 
                10px 15px 0 0 white, 
                35px 5px 0 -0.5px rgba(255,255,255,0.8), 
                50px 25px 0 0 white, 
                5px 40px 0 -0.5px rgba(255,255,255,0.6),
                45px 50px 0 0 white,
                25px 30px 0 -0.5px rgba(255,255,255,0.7);
            opacity: 0.7;
            animation: starry-twinkle 4s infinite ease-in-out alternate;
            z-index: 1;
        }

        /* Layer 2: Mountains (Using Clip Path) */
        .memory-frame.collected::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%; /* Height of mountains */
            background: #020617; /* Slate-950 (Near Black) */
            /* Jagged Mountain Silhouette */
            clip-path: polygon(0% 100%, 0% 40%, 20% 70%, 45% 20%, 70% 60%, 100% 10%, 100% 100%);
            z-index: 2;
            opacity: 0.9;
        }

        /* Layer 3: Foreground Number (Firefly/Moon) */
        .memory-frame.collected span {
            position: relative;
            z-index: 10; /* Above mountains */
            color: #FDE047; /* Yellow-300 */
            font-family: 'Playfair Display', serif; /* Elegant font */
            text-shadow: 0 0 10px #F59E0B, 0 0 20px #D97706; /* Amber Glow */
            animation: firefly-breathe 3s infinite ease-in-out alternate;
        }

        @keyframes starry-twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 0.9; transform: scale(1.1); }
        }

        @keyframes firefly-breathe {
            0% { transform: scale(1); opacity: 0.85; text-shadow: 0 0 10px #F59E0B; }
            100% { transform: scale(1.1); opacity: 1; text-shadow: 0 0 25px #FBBF24, 0 0 5px #FFF; }
        }

        .selection-mode .memory-frame:not(.collected) {
            cursor: pointer;
            border-color: var(--color-gold);
            animation: pulse-paper 2s infinite;
            z-index: 10;
        }

        @keyframes pulse-paper {
            0% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(184, 134, 11, 0.2); }
            50% { transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(184, 134, 11, 0.4); }
            100% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(184, 134, 11, 0.2); }
        }

        /* Mission Complete Animation */
        @keyframes slide-out-right {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(50px); opacity: 0; }
        }
        .mission-complete-anim {
            animation: slide-out-right 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
        }

        /* 4. Premium Gold Gradient Button */
        .btn-gold-gradient {
            background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728);
            background-size: 200% auto;
            transition: all 0.5s ease;
        }
        .btn-gold-gradient:hover {
            background-position: right center;
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(212,175,55,0.6);
        }
        .btn-gold-gradient:active {
            transform: scale(0.98);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animation Classes */
        .modal-enter { transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1); }
        .modal-enter-active { transform: translateY(0); }

        /* Manual Input Grid */
        .manual-input-cell {
            aspect-ratio: 1;
            text-align: center;
            font-size: 1.25rem;
            font-family: 'Noto Serif TC', serif;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            background: #FFF;
            transition: all 0.2s;
        }
        .manual-input-cell:focus {
            outline: none;
            border-color: var(--color-gold);
            box-shadow: 0 0 0 2px rgba(184, 134, 11, 0.1);
        }
        .manual-input-cell.duplicate {
            border-color: #EF4444;
            background-color: #FEF2F2;
            color: #EF4444;
        }

        /* Category Button active state */
        .category-btn.active {
            background-color: var(--color-gold);
            color: white;
            border-color: var(--color-gold);
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.3);
        }

        /* Scenic Mode Transitions */
        .game-ui {
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .scenic-mode .game-ui {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }
        .scenic-mode .fixed-action-btn {
            opacity: 0;
            pointer-events: none;
        }

        #scenic-return-hint {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .scenic-mode #scenic-return-hint {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Fix: Ensure exit button is not clickable when invisible */
        #exit-scenic-btn {
            pointer-events: none;
        }
        .scenic-mode #exit-scenic-btn {
            pointer-events: auto;
        }
        
        /* Updated Header Btn color for dark background */
        .header-btn {
            padding: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s;
        }
        .header-btn:hover { color: #D4AF37; opacity: 1; }
        .header-btn:active { transform: scale(0.9); }
        
        /* Music Track Item Active State */
        .track-item.active {
            border-color: #D4AF37;
            background-color: rgba(212, 175, 55, 0.1);
        }
        .track-item.active .track-icon {
            transform: scale(1.1);
        }

        /* Wheel Styles */
        .wheel-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto;
        }
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 6px solid #D4AF37;
            background: conic-gradient(
                #FFFFFF 0deg 60deg,
                #FDFBF7 60deg 120deg,
                #FFFFFF 120deg 180deg,
                #FDFBF7 180deg 240deg,
                #FFFFFF 240deg 300deg,
                #FDFBF7 300deg 360deg
            );
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        /* Wheel Lines */
        .wheel::after {
            content: "";
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(0deg, transparent 49.5%, #E2E8F0 49.5%, #E2E8F0 50.5%, transparent 50.5%),
                linear-gradient(60deg, transparent 49.5%, #E2E8F0 49.5%, #E2E8F0 50.5%, transparent 50.5%),
                linear-gradient(120deg, transparent 49.5%, #E2E8F0 49.5%, #E2E8F0 50.5%, transparent 50.5%);
            border-radius: 50%;
        }
        .wheel-pointer {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; 
            height: 0; 
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 24px solid #2C3E50;
            z-index: 20;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
        .wheel-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            background: white;
            border: 4px solid #D4AF37;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Tutorial Styles */
        .tutorial-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44, 62, 80, 0.85);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .tutorial-active .tutorial-overlay {
            opacity: 1;
            pointer-events: auto;
        }
        .tutorial-highlight {
            position: relative;
            z-index: 70 !important;
            box-shadow: 0 0 0 4px #D4AF37, 0 0 40px rgba(0,0,0,0.5) !important;
            transition: all 0.3s ease;
            background-color: #FFF; /* Ensure no transparency issues */
        }
        /* Special handling for glass card transparency in highlight mode */
        .glass-card.tutorial-highlight {
            background: #FFF; 
        }
        .tutorial-card {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 360px;
            background: #FFF;
            border: 1px solid #D4AF37;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            z-index: 80;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            opacity: 0;
            pointer-events: none;
        }
        .tutorial-active .tutorial-card {
            opacity: 1;
            pointer-events: auto;
        }
        .tutorial-card.position-bottom { bottom: 2rem; }
        .tutorial-card.position-top { top: 2rem; }
        .tutorial-card.position-center { top: 50%; transform: translate(-50%, -50%); }

        .dot-indicator {
            width: 8px; height: 8px; border-radius: 50%; background: #E2E8F0; transition: all 0.3s;
        }
        .dot-indicator.active {
            background: #D4AF37; width: 20px; border-radius: 4px;
        }
        
        /* --- NEW Reveal Modal Styles --- */
        
        /* 1. Sunburst Rays */
        .sunburst-rays {
            background: repeating-conic-gradient(
                from 0deg, 
                rgba(212, 175, 55, 0.4) 0deg 10deg, 
                transparent 10deg 20deg
            );
            animation: rotate-slow 20s linear infinite;
            mask-image: radial-gradient(circle, black 0%, transparent 70%);
            -webkit-mask-image: radial-gradient(circle, black 0%, transparent 70%);
        }
        @keyframes rotate-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 2. Premium Paper Texture */
        .paper-texture {
            background-color: #FDFBF7;
            /* Subtle noise pattern SVG data URI */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            box-shadow: inset 0 0 40px rgba(0,0,0,0.05), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #D4AF37;
        }

        /* 3. Floating Animation */
        @keyframes float-card {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .animate-float {
            animation: float-card 6s ease-in-out infinite;
        }

        /* 4. Stamp & Bounce Effect */
        @keyframes stamp-in-bounce {
            0% { transform: scale(3); opacity: 0; }
            50% { transform: scale(0.9); opacity: 1; }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .stamp-reveal {
            animation: stamp-in-bounce 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* 5. Fade In & Scale Up for Card */
        @keyframes scale-in-fade {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .card-enter-anim {
            animation: scale-in-fade 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #1a2a6c;
            background: linear-gradient(to bottom, #1a2a6c, #2C3E50);
            display: flex;
            flex-col: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease;
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 overflow-x-hidden">

    <div class="bg-overlay"></div>

    <!-- AUDIO SYSTEM -->
    <audio id="bgm-audio" loop preload="auto" playsinline style="position:absolute; width:0; height:0; opacity:0; pointer-events:none;">
    </audio>

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="text-center p-8 space-y-6 max-w-md animate-fade-in">
            <h1 class="text-5xl font-bold text-[#D4AF37] tracking-widest mb-2 font-serif drop-shadow-lg">æ„›ä¸Šå–œç¿</h1>
            <p class="text-xl text-white/90 tracking-wider font-light border-b border-white/20 pb-4 inline-block">å±±æ—æ‹¾å…‰æ”¶é›†å†Š</p>
            <div class="text-sm text-gray-300 leading-relaxed mt-4">
                <p>é–‹å•ŸéŸ³æ¨‚ï¼Œäº«å—æ²‰æµ¸å¼å±±æ—é«”é©—</p>
            </div>
            <button id="splash-start-btn" class="mt-8 px-10 py-4 bg-[#D4AF37] hover:bg-[#F0E68C] text-[#1a2a6c] rounded-full font-bold tracking-widest shadow-[0_0_30px_rgba(212,175,55,0.4)] transition-all active:scale-95 text-lg">
                ğŸŒ² é–‹å§‹é«”é©—
            </button>
            <p id="audio-status" class="text-xs text-gray-500 mt-4 min-h-[20px]">ğŸµ éŸ³æ¨‚æº–å‚™å°±ç·’</p>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="tutorial-overlay"></div>
    <div id="tutorial-card" class="tutorial-card position-center">
        <h3 id="tut-title" class="text-xl font-bold text-[#2C3E50] mb-2 font-serif tracking-widest"></h3>
        <p id="tut-desc" class="text-sm text-[#64748B] mb-6 leading-relaxed"></p>
        <div class="flex items-center justify-between">
            <div id="tut-dots" class="flex gap-1.5"></div>
            <div class="flex gap-2">
                <button id="tut-skip" class="text-gray-400 text-sm px-4 py-3 hover:text-gray-600 transition-colors">è·³é</button>
                <button id="tut-next" class="bg-[#2C3E50] text-white px-5 py-2 rounded-lg text-sm shadow-lg tracking-widest active:scale-95 transition-transform">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
    </div>

    <!-- Scenic Mode Return Hint -->
    <div id="scenic-return-hint" class="fixed inset-0 z-[100] flex flex-col items-center justify-end pb-12 pointer-events-none">
        <button id="exit-scenic-btn" class="bg-white/20 backdrop-blur-md border border-white/40 text-white px-8 py-3 rounded-full text-sm tracking-[0.3em] shadow-2xl active:scale-95 transition-transform">
            é»æ“Šè¿”å›æ”¶é›†å†Š
        </button>
    </div>

    <!-- Lucky Wheel Modal -->
    <div id="wheel-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/80 backdrop-blur-md transition-opacity duration-300 opacity-0">
        <div class="bg-white/95 w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-white/60 modal-enter flex flex-col items-center">
            <h3 class="text-2xl text-[#2C3E50] tracking-widest font-medium mb-2">å¹¸é‹è½‰ç›¤</h3>
            <p class="text-xs text-[#64748B] tracking-wider mb-6">æ¶ˆè€—ä¸€æ¬¡é€£ç·šæ©Ÿæœƒï¼ŒæŠ½å–é©šå–œå¥½ç¦®ï¼</p>
            <div class="wheel-container mb-8">
                <div class="wheel-pointer"></div>
                <div id="wheel-element" class="wheel"></div>
                <div class="wheel-center">ğŸŒŸ</div>
            </div>
            <div id="wheel-result-msg" class="text-[#D4AF37] font-bold text-lg h-8 mb-4"></div>
            <div class="flex gap-3 w-full">
                <button id="close-wheel-btn" class="flex-1 py-3 text-gray-400 text-sm font-medium">ç¨å¾Œå†è½‰</button>
                <button id="start-spin-btn" class="flex-1 bg-gradient-to-r from-[#B8860B] to-[#D4AF37] text-white py-3 rounded-lg text-sm tracking-widest shadow-md active:scale-95 transition-all font-bold">é–‹å§‹æŠ½ç</button>
            </div>
        </div>
    </div>

    <div id="app" class="relative z-10 w-full max-w-md flex flex-col min-h-[90vh]">
        
        <header class="pt-8 pb-4 text-center relative game-ui">
            <div class="absolute top-8 right-0 flex gap-2">
                <button id="music-menu-btn" class="header-btn" title="åˆ‡æ›èƒŒæ™¯éŸ³æ¨‚">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 18V5l12-2v13" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="6" cy="18" r="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="18" cy="16" r="3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button id="toggle-sound-btn" class="header-btn" title="éŸ³æ¨‚é–‹é—œ">
                    <svg id="icon-sound-off" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" />
                        <path d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                    </svg>
                    <svg id="icon-sound-on" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
                <button id="toggle-scenic-btn" class="header-btn" title="è§€è³èƒŒæ™¯">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </button>
                <button id="help-btn" class="header-btn" title="éŠæˆ²èªªæ˜">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            
            <div class="inline-flex flex-col items-center">
                <span class="text-[#D4AF37] text-xs tracking-[0.3em] uppercase mb-2 font-medium drop-shadow">Love Hsiung</span>
                <h1 class="text-4xl font-medium text-white tracking-widest mb-1 drop-shadow-lg font-serif">æ„›ä¸Šå–œç¿</h1>
                <div class="h-[1px] w-12 bg-[#D4AF37] my-3"></div>
                <h2 class="text-xl text-gray-200 tracking-[0.15em] font-light drop-shadow-md">å±±æ—æ‹¾å…‰æ”¶é›†å†Š</h2>
            </div>
        </header>

        <main class="flex-1 px-2 flex flex-col items-center relative game-ui">
            <div id="spin-area" class="w-full flex justify-between items-center px-4 mb-4 mt-2 bg-white/10 backdrop-blur rounded-lg py-2 transition-all border border-white/20">
                <div class="text-xs text-gray-100 tracking-wide">
                    é”æˆé€£ç·šï¼š<span id="total-lines" class="font-bold text-[#D4AF37] text-sm">0</span>
                </div>
                <button id="enter-wheel-btn" class="hidden flex items-center gap-2 bg-gradient-to-r from-[#2C3E50] to-[#1A252F] text-white px-4 py-2 rounded-full shadow-lg border border-[#D4AF37]/50 active:scale-95 transition-all">
                    <span class="text-lg">ğŸ¡</span>
                    <span class="text-xs tracking-widest font-bold">å¹¸é‹è½‰ç›¤ x<span id="spins-available">0</span></span>
                </button>
            </div>

            <div id="selection-banner" class="hidden w-full mb-6 animate-bounce z-20 pointer-events-none text-center">
                <div class="bg-gradient-to-r from-[#B8860B] to-[#D4AF37] text-white py-3 px-6 rounded-full shadow-xl text-sm tracking-widest font-bold border border-white/30 inline-block pointer-events-auto">
                    âœ¨ é»ƒé‡‘æ™‚åˆ»ï¼šè«‹é»æ“Šä»»ä¸€è³“æœæ ¼ âœ¨
                </div>
            </div>

            <div class="w-full flex justify-between items-end px-4 mb-3 mt-1">
                <span class="text-sm text-white font-medium tracking-wider drop-shadow-md">æˆ‘çš„å›æ†¶æ‹¼åœ–</span>
                <div class="flex items-baseline gap-1">
                    <span id="progress-text" class="text-2xl font-serif text-[#FCD34D] font-bold drop-shadow-sm">0</span>
                    <span class="text-sm text-gray-300">/ 25</span>
                </div>
            </div>

            <div class="glass-card p-4 rounded-[1.5rem] w-full shadow-2xl transition-transform duration-500" id="grid-card">
                <div id="grid-container" class="grid grid-cols-5 gap-2 w-full"></div>
            </div>

            <div class="mt-8 text-center px-6 pb-24">
                <p class="text-sm text-white/80 font-medium leading-loose italic tracking-wide drop-shadow-sm">
                    ã€Œæ¯ä¸€æ­¥è¶³è·¡ï¼Œ<br/>éƒ½æ˜¯å¯«çµ¦å¤§è‡ªç„¶çš„æƒ…æ›¸ã€‚ã€
                </p>
            </div>
        </main>

        <div id="main-action-area" class="fixed bottom-8 left-0 right-0 z-30 px-6 flex justify-center fixed-action-btn">
            <button id="open-missions-btn" class="w-full max-w-md btn-gold-gradient rounded-full shadow-2xl active:scale-95 border-2 border-white/20">
                <div class="relative py-4 flex items-center justify-center gap-3 text-[#2C3E50]">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    <span class="text-lg tracking-[0.2em] font-bold">é–‹å•Ÿæ¢éšªæ‰‹å†Š</span>
                </div>
            </button>
        </div>

        <!-- MODALS -->
        <div id="music-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/60 backdrop-blur-md transition-all duration-300 opacity-0">
            <div class="bg-white/95 w-full max-w-xs rounded-2xl p-6 shadow-2xl border border-white/50 modal-enter">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg text-[#2C3E50] font-medium tracking-wide">é¸æ“‡æ°›åœéŸ³æ¨‚</h3>
                    <button id="close-music-btn" class="text-gray-400 p-1 hover:text-[#2C3E50]">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="track-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="setup-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/80 backdrop-blur-md transition-opacity duration-300 opacity-0">
            <div class="bg-white/95 w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-white/60">
                <div class="text-center mb-6">
                    <h3 class="text-2xl text-[#2C3E50] tracking-widest font-medium mb-2">æº–å‚™æ‚¨çš„æ¢éšªåœ°åœ–</h3>
                    <p class="text-xs text-[#64748B] tracking-wider">è«‹é¸æ“‡è³“æœå¡ç‰‡æ•¸å­—çš„ç”¢ç”Ÿæ–¹å¼</p>
                </div>
                <div class="flex flex-col gap-4">
                    <button id="btn-setup-random" class="w-full py-4 bg-[#2C3E50] text-white rounded-xl shadow-lg active:scale-95 transition-all">éš¨æ©Ÿç”Ÿæˆ (1-30)</button>
                    <button id="btn-setup-manual" class="w-full py-4 border-2 border-[#2C3E50] text-[#2C3E50] rounded-xl shadow-sm active:scale-95 transition-all font-medium">æ‰‹å‹•å¡«å¯«</button>
                </div>
            </div>
        </div>

        <div id="manual-setup-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/90 backdrop-blur-lg transition-opacity duration-300 opacity-0">
            <div class="bg-[#FDFBF7] w-full max-w-md rounded-3xl p-6 shadow-2xl border border-white/50 flex flex-col h-[90vh] sm:h-auto">
                <div class="text-center mb-6 shrink-0">
                    <h3 class="text-2xl text-[#2C3E50] tracking-widest font-medium">ç·¨æ’å›æ†¶åœ°åœ–</h3>
                    <p class="text-xs text-[#8B7355] mt-1">è«‹åœ¨ 1-30 çš„ç©ºæ ¼ä¸­å¡«å…¥æ‚¨å¿ƒå„€çš„å¹¸é‹æ•¸å­—</p>
                </div>
                <div id="manual-input-grid" class="grid grid-cols-5 gap-2 flex-1 overflow-y-auto py-2 no-scrollbar"></div>
                <div class="mt-6 flex flex-col gap-3 shrink-0">
                    <div id="manual-validation-msg" class="text-center text-xs text-red-500 h-4 font-medium"></div>
                    <div class="flex gap-2">
                        <button id="btn-manual-autofill" class="flex-1 py-3 bg-white border border-[#D4AF37] text-[#B8860B] rounded-xl text-sm font-medium shadow-sm active:scale-95 transition-all">éš¨æ©Ÿè£œå®Œ</button>
                        <button id="btn-manual-clear" class="px-4 py-3 bg-gray-100 text-gray-500 rounded-xl text-sm active:scale-95 transition-all">æ¸…ç©º</button>
                    </div>
                    <button id="btn-manual-confirm" class="w-full py-4 bg-[#2C3E50] text-white rounded-xl shadow-lg active:scale-95 transition-all font-bold tracking-[0.2em] disabled:opacity-50 disabled:cursor-not-allowed">é–‹å§‹å±±æ—å†’éšª</button>
                </div>
            </div>
        </div>

        <div id="mission-modal" class="fixed inset-0 z-40 hidden flex items-end sm:items-center justify-center sm:p-4 bg-[#2C3E50]/40 backdrop-blur-sm transition-all duration-300 opacity-0">
            <div id="mission-content" class="bg-[#FCFCFC] w-full max-w-sm h-[80vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl rounded-t-3xl p-0 shadow-2xl modal-enter border border-white/60 flex flex-col overflow-hidden">
                <div class="p-6 pb-4 border-b border-gray-100 flex justify-between items-center bg-white shrink-0">
                    <div>
                        <h3 class="text-2xl text-[#2C3E50] tracking-widest font-medium">æ¢éšªä»»å‹™</h3>
                        <p class="text-xs text-[#8B96A0] mt-1 tracking-wider">å®Œæˆä»»å‹™ï¼Œè§£é–å›æ†¶æ‹¼åœ–</p>
                    </div>
                    <button id="close-mission-btn" class="text-gray-400 p-2 bg-gray-50 rounded-full">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="flex border-b border-gray-100 bg-white shrink-0">
                    <button id="tab-missions" class="flex-1 py-3 text-sm font-bold text-[#2C3E50] border-b-2 border-[#2C3E50] transition-colors">ç•¶å‰ä»»å‹™</button>
                    <button id="tab-guide" class="flex-1 py-3 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-[#2C3E50] transition-colors">æ”¶é›†åœ–é‘‘</button>
                </div>
                <div class="bg-white border-b border-gray-50 px-4 py-3 overflow-x-auto no-scrollbar shrink-0">
                    <div class="flex gap-2 min-w-max" id="category-filter-container">
                        <button class="category-btn active px-4 py-2 rounded-full border border-gray-200 text-xs font-medium tracking-widest transition-all" data-category="all">å…¨éƒ¨</button>
                        <button class="category-btn px-4 py-2 rounded-full border border-gray-200 text-xs font-medium tracking-widest transition-all" data-category="cloud">é›²ä¸Šç”Ÿæ´»</button>
                        <button class="category-btn px-4 py-2 rounded-full border border-gray-200 text-xs font-medium tracking-widest transition-all" data-category="photo">å±±æ—å¯«çœŸ</button>
                        <button class="category-btn px-4 py-2 rounded-full border border-gray-200 text-xs font-medium tracking-widest transition-all" data-category="explore">ç§˜å¯†æ¢ç´¢</button>
                        <button class="category-btn px-4 py-2 rounded-full border border-gray-200 text-xs font-medium tracking-widest transition-all" data-category="social">ç‡Ÿç«å¾®å…‰</button>
                        <button class="category-btn px-4 py-2 rounded-full border border-gray-200 text-xs font-medium tracking-widest transition-all" data-category="soul">éˆé­‚å°è©±</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar bg-[#F9FAFB]" id="mission-list-container"></div>
            </div>
        </div>

        <div id="input-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/60 backdrop-blur-md transition-all duration-300 opacity-0">
            <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl border border-white/50">
                <div class="text-center mb-6">
                    <span id="input-icon" class="text-4xl mb-4 block animate-bounce"></span>
                    <h3 id="input-title" class="text-xl text-[#2C3E50] mb-2 font-medium tracking-wide"></h3>
                    <p id="input-hint" class="text-xs text-[#64748B] leading-relaxed font-light"></p>
                </div>
                <div class="mb-4" id="staff-pin-container">
                    <label class="block text-xs text-gray-400 mb-1 text-center">å·¥ä½œäººå“¡é€šè¡Œç¢¼</label>
                    <input type="password" id="staff-pin-input" maxlength="4" placeholder="****" class="w-full text-center text-xl tracking-[0.5em] py-2 border-b border-[#E2E8F0] focus:outline-none">
                </div>
                <div class="flex gap-3">
                    <button id="cancel-input-btn" class="flex-1 py-3 text-gray-400 text-sm font-medium">å–æ¶ˆ</button>
                    <button id="submit-input-btn" class="flex-1 bg-[#2C3E50] text-white py-3 rounded-lg text-sm tracking-widest shadow-md active:scale-95 transition-all">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <!-- NEW RESULT MODAL (Luxurious Redesign) -->
        <div id="result-modal" class="fixed inset-0 z-50 hidden">
             <!-- 1. Background Image -->
             <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=2070&auto=format&fit=crop');"></div>
             <!-- 2. Dark Overlay -->
             <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-1000" id="result-bg-overlay"></div>
             <!-- 3. Sunburst Container -->
             <div class="absolute inset-0 flex items-center justify-center overflow-hidden pointer-events-none">
                  <div id="burst-rays" class="sunburst-rays w-[200vmax] h-[200vmax] opacity-0 transition-opacity duration-700"></div> 
             </div>
             <!-- 4. Main Content -->
             <div class="relative z-10 w-full h-full flex flex-col items-center justify-center p-6">
                  <!-- The Card -->
                  <div id="result-card" class="paper-texture w-64 aspect-[3/4] p-6 shadow-2xl relative flex flex-col items-center justify-center text-center opacity-0 transform scale-90 transition-none animate-float rounded-sm">
                       <!-- Inner decorative border -->
                       <div class="absolute inset-2 border border-[#D4AF37]/30 pointer-events-none"></div>
                       <!-- Content Wrapper -->
                       <div class="z-10 flex flex-col items-center gap-6 w-full">
                           <!-- Flavor Text -->
                           <div id="result-context-text" class="text-[#5C4033] text-sm font-serif italic font-medium leading-loose opacity-0 transition-opacity duration-700"></div>
                           <!-- The Number -->
                           <div class="flex flex-col items-center w-full">
                               <span class="text-[#B8860B] text-[10px] uppercase tracking-[0.2em] mb-1 opacity-60">Memory No.</span>
                               <span id="result-number-display" class="text-7xl text-[#B8860B] font-serif font-bold opacity-0 transform scale-150 transition-none drop-shadow-md break-all leading-tight"></span>
                           </div>
                       </div>
                       <!-- Decor Corner -->
                       <div class="absolute bottom-2 right-2 text-[#D4AF37]/20 text-4xl">â§</div>
                       <div class="absolute top-2 left-2 text-[#D4AF37]/20 text-4xl transform rotate-180">â§</div>
                  </div>
                  <!-- Title & Button Container (Fade in last) -->
                  <div id="result-actions" class="mt-10 flex flex-col items-center opacity-0 transition-opacity duration-700">
                      <h2 class="text-white/90 text-sm tracking-[0.4em] uppercase mb-6 font-light drop-shadow-lg">å°‹ç²æ‹¾å…‰</h2>
                      <button id="close-result-btn" class="px-12 py-3 border border-[#D4AF37] text-[#D4AF37] hover:bg-[#D4AF37] hover:text-[#2C3E50] rounded-full text-sm transition-all duration-300 backdrop-blur-sm bg-black/20">
                          æ”¶ä¸‹å›æ†¶
                      </button>
                  </div>
             </div>
        </div>

    </div>

    <script>
        const SECURITY = { STAFF_PIN: '1688' };

        // --- Sound Manager Class ---
        class SoundManager {
            constructor() {
                this.bgmAudio = document.getElementById('bgm-audio');
                this.bgmAudio.volume = 0.5;
                this.isEnabled = false;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                this.playlist = [
                    { id: 'forest', name: 'æ™¨é–“æ£®æ—', icon: 'ğŸŒ²', url: 'https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3' }
                ];
                
                const savedTrack = localStorage.getItem('love_hsiung_track_index');
                this.currentTrackIndex = savedTrack ? parseInt(savedTrack) : 0;
                if (this.currentTrackIndex >= this.playlist.length) this.currentTrackIndex = 0;
                
                this.bgmAudio.src = this.playlist[this.currentTrackIndex].url;
            }

            enable() {
                this.isEnabled = true;
                this.bgmAudio.muted = false;
                this.bgmAudio.volume = 0.5;
                const playPromise = this.bgmAudio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => console.warn("BGM Play failed.", error));
                }
            }

            disable() {
                this.isEnabled = false;
                this.bgmAudio.pause();
            }

            toggle() {
                if (this.isEnabled) this.disable();
                else this.enable();
                return this.isEnabled;
            }
            
            setTrack(index) {
                if (index < 0 || index >= this.playlist.length) return;
                this.currentTrackIndex = index;
                localStorage.setItem('love_hsiung_track_index', index);
                this.bgmAudio.src = this.playlist[index].url;
                if (this.isEnabled) this.bgmAudio.play().catch(e => console.log(e));
                document.dispatchEvent(new CustomEvent('trackChanged', { detail: { index: index } }));
            }

            playClick() {
                if (!this.isEnabled) return;
                try {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                    gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 0.1);
                } catch(e) {}
            }

            playSuccess() {
                if (!this.isEnabled) return;
                try {
                    const now = this.ctx.currentTime;
                    [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();
                        osc.connect(gain);
                        gain.connect(this.ctx.destination);
                        osc.frequency.value = freq;
                        const delay = i * 0.08;
                        gain.gain.setValueAtTime(0, now + delay);
                        gain.gain.linearRampToValueAtTime(0.1, now + delay + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 1.2);
                        osc.start(now + delay);
                        osc.stop(now + delay + 1.2);
                    });
                } catch(e) {}
            }

            playReveal() {
                if (!this.isEnabled) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    const now = this.ctx.currentTime;
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.6);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.6);
                    osc.start();
                    osc.stop(now + 0.6);
                } catch(e) {}
            }
        }

        // --- Tutorial Manager Class ---
        class TutorialManager {
            constructor() {
                this.steps = [
                    { id: 'welcome', target: null, title: 'æ­¡è¿ä¾†åˆ°æ„›ä¸Šå–œç¿', desc: 'é€™æ˜¯ä¸€å ´å°ˆå±¬æ–¼æ‚¨çš„å±±æ—æ¢éšªã€‚æ”¶é›†ç¾å¥½å›æ†¶ï¼Œå®Œæˆé€£ç·šå³å¯å…Œæ›é©šå–œå¥½ç¦®ï¼', pos: 'center' },
                    { id: 'grid', target: 'grid-card', title: 'å›æ†¶åœ°åœ–', desc: 'é€™æ˜¯æ‚¨çš„è³“æœå¡ã€‚æ¯ä¸€å€‹æ•¸å­—éƒ½ä»£è¡¨ä¸€æ®µç¨ç‰¹çš„å›æ†¶æˆ–ä»»å‹™ã€‚', pos: 'bottom' },
                    { id: 'mission', target: 'open-missions-btn', title: 'æ¢éšªæ‰‹å†Š', desc: 'é»æ“Šæ­¤è™•æŸ¥çœ‹ä»»å‹™æ¸…å–®ã€‚å®Œæˆä»»å‹™å¯ç²å¾—éš¨æ©Ÿè™Ÿç¢¼ï¼Œé»äº®æ‚¨çš„åœ°åœ–ã€‚', pos: 'top' },
                    { id: 'music', target: 'music-menu-btn', title: 'æ£®æ—æ¨‚ç« ', desc: 'é»æ“Šæ­¤è™•å¯åˆ‡æ›èƒŒæ™¯éŸ³æ¨‚ï¼ŒåŒ…å«èŸ²é³´ã€ç‡Ÿç«ç­‰å¤§è‡ªç„¶è²éŸ³ï¼Œæå‡éœ²ç‡Ÿæ°›åœã€‚', pos: 'bottom' },
                    { id: 'scenic', target: 'toggle-scenic-btn', title: 'éœäº«å±±æ—', desc: 'æƒ³å°ˆå¿ƒæ¬£è³é¢¨æ™¯å—ï¼Ÿé»æ“Šçœ¼ç›åœ–ç¤ºå¯æš«æ™‚éš±è—æ‰€æœ‰ä»‹é¢ã€‚', pos: 'bottom' }
                ];
                this.currentStep = 0;
                this.isActive = false;
                
                this.overlay = document.getElementById('tutorial-overlay');
                this.card = document.getElementById('tutorial-card');
                this.title = document.getElementById('tut-title');
                this.desc = document.getElementById('tut-desc');
                this.dotsContainer = document.getElementById('tut-dots');
                this.btnNext = document.getElementById('tut-next');
                this.btnSkip = document.getElementById('tut-skip');

                this.btnNext.onclick = () => this.next();
                this.btnSkip.onclick = () => this.end();
            }

            start() {
                this.isActive = true;
                this.currentStep = 0;
                document.body.classList.add('tutorial-active');
                this.renderStep();
                soundManager.playClick();
            }

            end() {
                this.isActive = false;
                document.body.classList.remove('tutorial-active');
                this.clearHighlight();
                localStorage.setItem('love_hsiung_tutorial_seen', 'true');
                soundManager.playClick();
            }

            next() {
                soundManager.playClick();
                if (this.currentStep < this.steps.length - 1) {
                    this.currentStep++;
                    this.renderStep();
                } else {
                    this.end();
                }
            }

            clearHighlight() {
                document.querySelectorAll('.tutorial-highlight').forEach(el => {
                    el.classList.remove('tutorial-highlight');
                });
                const actionArea = document.getElementById('main-action-area');
                if (actionArea) actionArea.style.zIndex = '';
            }

            renderStep() {
                this.clearHighlight();
                const step = this.steps[this.currentStep];
                this.title.innerText = step.title;
                this.desc.innerText = step.desc;
                this.btnNext.innerText = this.currentStep === this.steps.length - 1 ? 'é–‹å§‹æ¢éšª' : 'ä¸‹ä¸€æ­¥';
                this.card.className = `tutorial-card position-${step.pos}`;

                if (step.target) {
                    const el = document.getElementById(step.target);
                    if (el) {
                        el.classList.add('tutorial-highlight');
                        if (step.target === 'open-missions-btn') {
                             document.getElementById('main-action-area').style.zIndex = '70';
                        }
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                this.dotsContainer.innerHTML = this.steps.map((_, i) => 
                    `<div class="dot-indicator ${i === this.currentStep ? 'active' : ''}"></div>`
                ).join('');
            }

            checkFirstTime() {
                if (!localStorage.getItem('love_hsiung_tutorial_seen')) {
                    setTimeout(() => this.start(), 800);
                }
            }
        }

        const soundManager = new SoundManager();
        const tutorialManager = new TutorialManager();

        const CATEGORIES = {
            cloud: { label: 'é›²ä¸Šç”Ÿæ´»', icon: 'â˜ï¸', color: 'bg-sky-50 text-sky-700', border: 'border-sky-200' },
            photo: { label: 'å±±æ—å¯«çœŸ', icon: 'ğŸ“¸', color: 'bg-indigo-50 text-indigo-700', border: 'border-indigo-200' },
            explore: { label: 'ç§˜å¯†æ¢ç´¢', icon: 'ğŸ—ºï¸', color: 'bg-emerald-50 text-emerald-700', border: 'border-emerald-200' },
            social: { label: 'ç‡Ÿç«å¾®å…‰', icon: 'ğŸ”¥', color: 'bg-orange-50 text-orange-700', border: 'border-orange-200' },
            soul: { label: 'éˆé­‚å°è©±', icon: 'ğŸŒ²', color: 'bg-purple-50 text-purple-700', border: 'border-purple-200' }
        };

        const MEMORY_LIST = [
            // ==========================================
            // â˜ï¸ ç¬¬ä¸€ç« ï¼šé›²ä¸Šç”Ÿæ´» (Cloud Life)
            // ==========================================
            { 
                id: 'food_dinner', 
                category: 'cloud',
                title: 'ğŸ½ï¸ æ™šé¤ï¼šå…‰ç›¤è¡Œå‹• (â˜…â˜…)', 
                type: 'staff_number', 
                difficulty: 2, 
                success_text: 'æ„Ÿè¬ä½ å°å¤§åœ°çš„æº«æŸ”ï¼Œé€™ä»½çæƒœåŒ–ç‚ºäº†...' 
            },
            { 
                id: 'food_breakfast', 
                category: 'cloud',
                title: 'ğŸ¥£ æ—©é¤ï¼šæ´»åŠ›æ»¿æ»¿ (â˜…)', 
                type: 'staff_number', 
                difficulty: 1, 
                success_text: 'æ™¨å…‰å–šé†’äº†å‘³è•¾ï¼Œé€™ä»½æ´»åŠ›åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'activity_archery', 
                category: 'cloud',
                title: 'ğŸ¹ çµäººå°„ç®­é«”é©— (â˜…â˜…â˜…)', 
                type: 'staff_number', 
                difficulty: 3, 
                success_text: 'å¦‚é·¹ä¸€èˆ¬çš„å°ˆæ³¨çœ¼ç¥ï¼Œè¢«å±±æ—éŠ˜è¨˜ç‚º...' 
            },
            { 
                id: 'gold_boss', 
                category: 'cloud',
                title: 'ğŸŒŸ é»ƒé‡‘ä»»å‹™ï¼šç‡Ÿä¸»å¤§æŒ‘æˆ° (â˜…â˜…â˜…)', 
                type: 'user_choice', 
                difficulty: 3, 
                success_text: 'ä½ è§¸å‹•äº†å±±ç¥çš„å¥‡è¹Ÿï¼Œé€™ä»½æ¦®è€€åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'life_chill', 
                category: 'cloud',
                title: 'ğŸ¹ åœ¨å¤©å¹•ä¸‹å–æ¯èŒ¶ (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'èŒ¶é¦™èˆ‡é¢¨å…±èˆï¼Œé€™ä»½æ‚ é–’åŒ–ç‚ºäº†...' 
            },

            // ==========================================
            // ğŸ“¸ ç¬¬äºŒç« ï¼šå±±æ—å¯«çœŸ (Mountain Photography)
            // ==========================================
            { 
                id: 'view_cloud', 
                category: 'photo',
                title: 'ğŸ“¸ é›²æµ·è§€æ™¯å°åˆç…§ (â˜…â˜…)', 
                type: 'code_draw', 
                difficulty: 2, 
                success_text: 'ä½ æ”¶è—äº†é›²æµ·çš„å‘¼å¸ï¼Œé€™ç‰‡åˆ»æ°¸æ†åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'photo_dew', 
                category: 'photo',
                title: 'ğŸ’§ æ‹ä¸‹æ¸…æ™¨çš„éœ²ç  (â˜…â˜…)', 
                type: 'code_draw', 
                difficulty: 2, 
                success_text: 'æ™¶ç‘©å‰”é€çš„æ™¨å…‰ï¼Œé€™ä»½ç´”æ·¨åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'photo_flower', 
                category: 'photo',
                title: 'ğŸŒ¸ æ‹ä¸‹ç‡Ÿå€æœ€ç¾çš„èŠ± (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'èŠ±æœµå› ä½ çš„æ³¨è¦–è€Œç¶»æ”¾ï¼Œé€™ä»½ç¾éº—åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'photo_smile', 
                category: 'photo',
                title: 'ğŸ˜Š æ‹ä¸€å¼µæœ€ç‡¦çˆ›çš„ç¬‘å®¹ (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'ç¬‘å®¹æ˜¯ä¸–ç•Œä¸Šæœ€ç¾çš„é¢¨æ™¯ï¼Œé€™ä»½å¿«æ¨‚åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'photo_group', 
                category: 'photo',
                title: 'ğŸ‘¥ é‚€è«‹è·¯äººå¹«æ‹åˆç…§ (â˜…â˜…)', 
                type: 'code_draw', 
                difficulty: 2, 
                success_text: 'å®šæ ¼äº†ç›¸èšçš„ç·£åˆ†ï¼Œé€™å¼µç…§ç‰‡åŒ–ç‚ºäº†...' 
            },

            // ==========================================
            // ğŸ—ºï¸ ç¬¬ä¸‰ç« ï¼šç§˜å¯†æ¢ç´¢ (Secret Exploration)
            // ==========================================
            { 
                id: 'explore_star', 
                category: 'explore',
                title: 'ğŸŒŒ æ‰¾åˆ°å¤œç©ºä¸­æœ€äº®é‚£é¡†æ˜Ÿ (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'æ˜Ÿå…‰ç©¿è¶Šå…‰å¹´è€Œä¾†ï¼Œåªç‚ºé»äº®ä½ çš„...' 
            },
            { 
                id: 'explore_bird', 
                category: 'explore',
                title: 'ğŸ¦ éŒ„ä¸‹ä¸€æ®µé³¥å«è² (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'æ£®æ—æ­Œæ‰‹ç‚ºä½ ç»å”±ï¼Œé€™é¦–æ—‹å¾‹åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'explore_barefoot', 
                category: 'explore',
                title: 'ğŸ¦¶ èµ¤è…³è¸©åœ¨è‰åœ°ä¸Š (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'å¤§åœ°é›»æµç©¿é€è…³å¿ƒï¼Œé€™ä»½é€£çµåŒ–ç‚ºäº†...' 
            },
            { 
                id: 'explore_tree', 
                category: 'explore',
                title: 'ğŸŒ³ æ“æŠ±ä¸€æ£µå¤§æ¨¹ 10 ç§’ (â˜…â˜…â˜…)', 
                type: 'code_draw', 
                difficulty: 3, 
                success_text: 'è€æ¨¹å‚³éäº†ç™¾å¹´çš„æ™ºæ…§ï¼Œé€™ä»½åŠ›é‡åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'explore_insect', 
                category: 'explore',
                title: 'ğŸ è§€å¯Ÿä¸€éš»å°æ˜†èŸ² (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'å¾®å°çš„ç”Ÿå‘½ä¹Ÿæœ‰å¤§å¤§çš„ä¸–ç•Œï¼Œé€™ä»½è§€å¯ŸåŒ–ç‚ºäº†...' 
            },

            // ==========================================
            // ğŸ”¥ ç¬¬å››ç« ï¼šç‡Ÿç«å¾®å…‰ (Campfire Glimmer)
            // ==========================================
            { 
                id: 'social_hi', 
                category: 'social',
                title: 'ğŸ‘‹ è·Ÿéš”å£å¸³ç¯·æ‰“æ‹›å‘¼ (â˜…)', 
                type: 'user_choice', 
                difficulty: 1, 
                success_text: 'å¾®ç¬‘æ˜¯æœ€å¥½çš„èªè¨€ï¼Œé€™ä»½å‹èª¼åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'social_staff', 
                category: 'social',
                title: 'â¤ï¸ è·Ÿå·¥ä½œäººå“¡èªªè²è¾›è‹¦äº† (â˜…â˜…)', 
                type: 'staff_number', 
                difficulty: 2, 
                success_text: 'ä½ çš„é«”è²¼æº«æš–äº†äººå¿ƒï¼Œé€™ä»½å–„æ„åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'social_snack', 
                category: 'social',
                title: 'ğŸª åˆ†äº«é›¶é£Ÿçµ¦æ–°æœ‹å‹ (â˜…â˜…)', 
                type: 'user_choice', 
                difficulty: 2, 
                success_text: 'åˆ†äº«è®“å¿«æ¨‚åŠ å€ï¼Œé€™ä»½æ…·æ…¨åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'social_highfive', 
                category: 'social',
                title: 'âœ‹ è·Ÿç®¡å®¶æ“ŠæŒ High Five (â˜…)', 
                type: 'staff_number', 
                difficulty: 1, 
                success_text: 'æ¸…è„†çš„æŒè²éŸ¿å¾¹å±±æ—ï¼Œé€™ä»½ç†±æƒ…åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'social_cheers', 
                category: 'social',
                title: 'ğŸ» èˆ‰æ¯æ…¶ç¥é€™ä¸€åˆ» (â˜…)', 
                type: 'user_choice', 
                difficulty: 1, 
                success_text: 'ä¹¾æ¯çš„è²éŸ³æ˜¯å¿«æ¨‚çš„æ¨‚ç« ï¼Œé€™ä»½æ…¶ç¥åŒ–ç‚ºäº†...' 
            },

            // ==========================================
            // ğŸŒ² ç¬¬äº”ç« ï¼šéˆé­‚å°è©± (Soul Dialogue)
            // ==========================================
            { 
                id: 'deep_shout', 
                category: 'soul',
                title: 'ğŸŒ² å°è‘—å¤§å±±å–Šå‡ºç…©æƒ± (â˜…â˜…)', 
                type: 'code_draw', 
                difficulty: 2, 
                success_text: 'å±±è°·æ¥ç´äº†ä½ çš„ç§˜å¯†ï¼Œå›éŸ³åŒ–ç‚ºäº†ç¥ç¦...' 
            },
            { 
                id: 'deep_letter', 
                category: 'soul',
                title: 'âœï¸ å¯«çµ¦æ˜å¹´è‡ªå·±çš„ä¸€å¥è©± (â˜…â˜…â˜…)', 
                type: 'user_choice', 
                difficulty: 3, 
                success_text: 'æ™‚å…‰è† å›Šå·²å°å­˜ï¼Œé€™ä»½æœŸè¨±åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'deep_meditate', 
                category: 'soul',
                title: 'ğŸ§˜ åœ¨æ¨¹ä¸‹é–‰çœ¼ç™¼å‘† (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'åœ¨å¯§éœä¸­æ‰¾å›äº†é »ç‡ï¼Œé€™ä»½å¹³éœåŒ–ç‚ºäº†...' 
            },
            { 
                id: 'deep_secret', 
                category: 'soul',
                title: 'ğŸ¤« è·Ÿæ—…ä¼´åˆ†äº«ä¸€å€‹ç§˜å¯† (â˜…â˜…â˜…)', 
                type: 'user_choice', 
                difficulty: 3, 
                success_text: 'ä¿¡ä»»æ˜¯éˆé­‚çš„æ“æŠ±ï¼Œé€™ä»½è¦ªå¯†åŒ–ç‚ºäº†...' 
            },
            { 
                id: 'deep_thank', 
                category: 'soul',
                title: 'ğŸ™ åœ¨å¿ƒè£¡æ„Ÿè¬ä¸€å€‹äºº (â˜…)', 
                type: 'code_draw', 
                difficulty: 1, 
                success_text: 'æ„Ÿæ©çš„å¿ƒæœƒç™¼å…‰ï¼Œé€™ä»½è¬æ„åŒ–ç‚ºäº†...' 
            }
        ];

        const CONFIG = { gridSize: 25, numberRange: 30, storageKey: 'love_hsiung_bingo_v10_final' };

        let state = { grid: [], markedIndices: [], completedMissions: [], isSelectionMode: false, claimedLines: 0, currentFilter: 'all', currentView: 'missions' };
        let currentMission = null;

        const els = {
            grid: document.getElementById('grid-container'),
            progress: document.getElementById('progress-text'),
            totalLines: document.getElementById('total-lines'),
            modalMissions: document.getElementById('mission-modal'),
            missionContent: document.getElementById('mission-content'),
            missionList: document.getElementById('mission-list-container'),
            categoryFilter: document.getElementById('category-filter-container'),
            modalInput: document.getElementById('input-modal'),
            modalResult: document.getElementById('result-modal'),
            modalSetup: document.getElementById('setup-modal'),
            modalManual: document.getElementById('manual-setup-modal'),
            manualGrid: document.getElementById('manual-input-grid'),
            manualConfirm: document.getElementById('btn-manual-confirm'),
            manualValidation: document.getElementById('manual-validation-msg'),
            inputIcon: document.getElementById('input-icon'),
            inputTitle: document.getElementById('input-title'),
            inputHint: document.getElementById('input-hint'),
            inputField: document.getElementById('passcode-input'),
            staffPinField: document.getElementById('staff-pin-input'),
            staffPinContainer: document.getElementById('staff-pin-container'),
            toggleScenic: document.getElementById('toggle-scenic-btn'),
            toggleSound: document.getElementById('toggle-sound-btn'),
            btnHelp: document.getElementById('help-btn'),
            exitScenic: document.getElementById('exit-scenic-btn'),
            splashScreen: document.getElementById('splash-screen'),
            splashStartBtn: document.getElementById('splash-start-btn'),
            audioStatus: document.getElementById('audio-status'),
            musicMenuBtn: document.getElementById('music-menu-btn'),
            modalMusic: document.getElementById('music-modal'),
            closeMusicBtn: document.getElementById('close-music-btn'),
            trackList: document.getElementById('track-list'),
            enterWheelBtn: document.getElementById('enter-wheel-btn'),
            modalWheel: document.getElementById('wheel-modal'),
            startSpinBtn: document.getElementById('start-spin-btn'),
            closeWheelBtn: document.getElementById('close-wheel-btn'),
            wheelElement: document.getElementById('wheel-element'),
            wheelResultMsg: document.getElementById('wheel-result-msg')
        };

        function saveState() { localStorage.setItem(CONFIG.storageKey, JSON.stringify(state)); }
        
        function loadState() {
            const saved = localStorage.getItem(CONFIG.storageKey);
            if (saved) {
                state = JSON.parse(saved);
                if (!state.currentFilter) state.currentFilter = 'all';
                if (!state.currentView) state.currentView = 'missions';
                renderGrid();
                updateStats();
            }
        }

        function renderGrid() {
            els.grid.innerHTML = '';
            state.grid.forEach((num, index) => {
                const isMarked = state.markedIndices.includes(index);
                const div = document.createElement('div');
                div.className = `memory-frame flex items-center justify-center relative select-none ${isMarked ? 'collected' : ''}`;
                
                if (isMarked) {
                    div.innerHTML = `<span class="text-3xl font-serif font-bold firefly-glow z-10 relative">${num}</span>`;
                } else {
                    div.innerHTML = `<span class="text-2xl text-[#5C4033] font-serif font-bold">${num}</span>`;
                    if (state.isSelectionMode) div.onclick = () => handleUserSelection(index);
                }
                els.grid.appendChild(div);
            });
            document.getElementById('selection-banner').classList.toggle('hidden', !state.isSelectionMode);
        }

        function renderMissionList() {
            els.missionList.innerHTML = '';
            const isGuide = state.currentView === 'guide';
            const tabMissions = document.getElementById('tab-missions');
            const tabGuide = document.getElementById('tab-guide');
            
            if (tabMissions && tabGuide) {
                tabMissions.className = !isGuide 
                    ? 'flex-1 py-3 text-sm font-bold text-[#2C3E50] border-b-2 border-[#2C3E50] transition-colors bg-white' 
                    : 'flex-1 py-3 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-[#2C3E50] transition-colors bg-gray-50';
                tabGuide.className = isGuide 
                    ? 'flex-1 py-3 text-sm font-bold text-[#2C3E50] border-b-2 border-[#2C3E50] transition-colors bg-white' 
                    : 'flex-1 py-3 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-[#2C3E50] transition-colors bg-gray-50';
            }
            
            els.categoryFilter.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category == state.currentFilter);
            });
            
            const filtered = state.currentFilter === 'all' 
                ? MEMORY_LIST 
                : MEMORY_LIST.filter(m => m.category == state.currentFilter);

            if (filtered.length === 0) {
                els.missionList.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                        <div class="text-4xl mb-4">ğŸŒ¿</div>
                        <p class="text-sm font-light tracking-widest">æ­¤å€åŸŸç›®å‰ç„¡å¯é€²è¡Œçš„ä»»å‹™</p>
                    </div>
                `;
                return;
            }

            if (isGuide) {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-3';
                let lastCategory = '';

                filtered.forEach(m => {
                    // Inject Header if All View and Category Changes
                    if (state.currentFilter === 'all' && m.category !== lastCategory) {
                        lastCategory = m.category;
                        const catConfig = CATEGORIES[m.category];
                        const header = document.createElement('div');
                        header.className = 'col-span-full mt-4 mb-2';
                        header.innerHTML = `
                            <h3 class="text-[#B8860B] font-bold text-sm tracking-widest border-b border-[#D4AF37]/30 pb-1 flex items-center gap-2">
                                <span>${catConfig.icon}</span>
                                <span>${catConfig.label}</span>
                            </h3>
                        `;
                        grid.appendChild(header);
                    }

                    const isCollected = state.completedMissions.includes(m.id);
                    const item = document.createElement('div');
                    item.className = `p-3 rounded-xl border flex flex-col gap-2 relative overflow-hidden transition-all ${isCollected ? "bg-white border-[#D4AF37] shadow-sm" : "bg-gray-100 border-gray-200 opacity-60 grayscale"}`;
                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <span class="text-2xl">ğŸŒŸ</span>
                            ${isCollected ? '<span class="text-[#D4AF37] text-xs font-bold">â˜… GET</span>' : '<span class="text-gray-400 text-xs font-bold tracking-widest">LOCKED</span>'}
                        </div>
                        <div>
                            <h4 class="text-[#2C3E50] font-bold text-sm truncate">${m.title}</h4>
                            <div class="flex items-center gap-1 mt-1">
                                 <span class="text-[#D4AF37] text-[10px]">${'â˜…'.repeat(m.difficulty)}</span>
                            </div>
                        </div>
                    `;
                    grid.appendChild(item);
                });
                els.missionList.appendChild(grid);
            } else {
                let lastCategory = '';
                
                filtered.forEach(m => {
                    // Inject Header if All View
                    if (state.currentFilter === 'all' && m.category !== lastCategory) {
                        lastCategory = m.category;
                        const catConfig = CATEGORIES[m.category];
                        const header = document.createElement('div');
                        header.className = 'mt-6 mb-3 first:mt-0';
                        header.innerHTML = `
                            <h3 class="text-[#B8860B] font-bold text-sm tracking-widest border-b border-[#D4AF37]/30 pb-1 flex items-center gap-2">
                                <span>${catConfig.icon}</span>
                                <span>${catConfig.label}</span>
                            </h3>
                        `;
                        els.missionList.appendChild(header);
                    }

                    const isDone = state.completedMissions.includes(m.id);
                    const stars = 'â˜…'.repeat(m.difficulty);
                    const cat = CATEGORIES[m.category];
                    
                    const card = document.createElement('div');
                    card.className = `p-4 rounded-xl border-2 transition-all relative overflow-hidden bg-white ${isDone ? 'border-gray-100 opacity-60' : 'border-gray-50 shadow-sm active:scale-95'}`;
                    card.dataset.missionId = m.id;
                    
                    card.innerHTML = `
                        <div class="flex flex-col gap-3 pointer-events-none">
                            <div class="flex justify-between items-start">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold tracking-widest ${cat.color} ${cat.border} border uppercase flex items-center gap-1">
                                    ${cat.label}
                                </span>
                                <span class="text-[#D4AF37] text-xs">${stars}</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 flex items-center justify-center bg-gray-50 rounded-full text-2xl shrink-0">ğŸŒŸ</div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-[#2C3E50] font-bold text-base truncate">${m.title}</h4>
                                </div>
                                <div class="px-4 py-2 rounded-lg text-xs font-bold shrink-0 ${isDone ? 'text-green-600 bg-green-50' : 'bg-[#2C3E50] text-white'}">
                                    ${isDone ? 'âœ“ å®Œæˆ' : 'é©—è­‰'}
                                </div>
                            </div>
                        </div>
                    `;
                    if (!isDone) {
                        card.classList.remove('pointer-events-none');
                        card.onclick = (e) => {
                            e.stopPropagation();
                            soundManager.playClick();
                            openInputModal(m);
                        };
                    }
                    els.missionList.appendChild(card);
                });
            }
        }

        function openModal(modal) {
            modal.classList.remove('hidden');
            const content = modal.querySelector('.modal-enter');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                if (content) content.classList.add('modal-enter-active');
            }, 10);
        }

        function closeModal(modal) {
            const content = modal.querySelector('.modal-enter');
            modal.classList.add('opacity-0');
            if (content) content.classList.remove('modal-enter-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        function renderTrackList() {
            els.trackList.innerHTML = '';
            soundManager.playlist.forEach((track, index) => {
                const isActive = index === soundManager.currentTrackIndex;
                const btn = document.createElement('button');
                btn.className = `track-item w-full flex items-center gap-4 p-3 rounded-xl border border-transparent transition-all hover:bg-gray-50 ${isActive ? 'active' : ''}`;
                btn.innerHTML = `
                    <div class="track-icon w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-lg transition-transform">${track.icon}</div>
                    <div class="flex-1 text-left">
                        <div class="text-[#2C3E50] font-medium text-sm tracking-wide">${track.name}</div>
                        ${isActive ? '<div class="text-[10px] text-[#D4AF37] font-bold mt-0.5 animate-pulse">æ­£åœ¨æ’­æ”¾</div>' : ''}
                    </div>
                `;
                btn.onclick = () => {
                    soundManager.setTrack(index);
                    soundManager.playClick();
                };
                els.trackList.appendChild(btn);
            });
        }
        document.addEventListener('trackChanged', renderTrackList);
        els.musicMenuBtn.onclick = () => { soundManager.playClick(); renderTrackList(); openModal(els.modalMusic); }
        els.closeMusicBtn.onclick = () => closeModal(els.modalMusic);

        function openInputModal(m) {
            currentMission = m;
            els.inputIcon.innerText = 'ğŸŒŸ';
            els.inputTitle.innerText = m.title;
            els.inputHint.innerText = 'å®Œæˆä»»å‹™å¾Œï¼Œè«‹å·¥ä½œäººå“¡è¼¸å…¥é€šè¡Œç¢¼ï¼Œæˆ–è‡ªè¡Œé©—è­‰ã€‚';
            els.staffPinField.value = '';
            const needsPin = m.type === 'staff_number';
            els.staffPinContainer.classList.toggle('hidden', !needsPin);
            openModal(els.modalInput);
        }

        function updateStats() {
            els.progress.innerText = state.markedIndices.length;
            const lines = calculateLines();
            els.totalLines.innerText = lines;
            const spins = Math.max(0, lines - (state.claimedLines || 0));
            document.getElementById('spins-available').innerText = spins;
            document.getElementById('enter-wheel-btn').classList.toggle('hidden', spins <= 0);
        }

        function calculateLines() {
            const patterns = [
                [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
                [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
                [0,6,12,18,24], [4,8,12,16,20]
            ];
            return patterns.filter(p => p.every(i => state.markedIndices.includes(i))).length;
        }

        els.enterWheelBtn.onclick = () => {
            soundManager.playClick();
            if (Math.max(0, calculateLines() - (state.claimedLines || 0)) > 0) openModal(els.modalWheel);
            else alert("ç›®å‰æ²’æœ‰å¯ç”¨çš„è½‰ç›¤æ©Ÿæœƒï¼");
        };
        els.closeWheelBtn.onclick = () => closeModal(els.modalWheel);

        let isSpinning = false;
        els.startSpinBtn.onclick = () => {
            if(isSpinning) return;
            const spins = Math.max(0, calculateLines() - (state.claimedLines || 0));
            if (spins <= 0) return;
            isSpinning = true;
            els.startSpinBtn.disabled = true;
            els.startSpinBtn.classList.add('opacity-50', 'cursor-not-allowed');
            soundManager.playClick();
            const segments = ['ç¥ç§˜å°ç¦®ç‰©', 'é£²å“å…Œæ›åˆ¸', 'ç‡Ÿç«æ£‰èŠ±ç³–', 'æ‹ç«‹å¾—ä¸€å¼µ', 'æ™šé¤åŠ èœ', 'ä¸‹æ¬¡ä½å®¿9æŠ˜'];
            const prizeIndex = Math.floor(Math.random() * segments.length);
            const extraSpins = 5 * 360;
            const randomAngle = Math.floor(Math.random() * 360);
            const totalRotation = extraSpins + randomAngle;
            els.wheelElement.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
            els.wheelElement.style.transform = `rotate(${totalRotation}deg)`;
            setTimeout(() => {
                isSpinning = false;
                state.claimedLines = (state.claimedLines || 0) + 1;
                saveState();
                updateStats();
                els.wheelResultMsg.innerText = `ğŸ‰ æ­å–œç²å¾—ï¼š${segments[Math.floor(((360 - (randomAngle % 360)) % 360) / (360/segments.length))]}`;
                soundManager.playSuccess();
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
            }, 4000);
        };

        els.splashStartBtn.onclick = () => {
            els.audioStatus.innerText = "ğŸµ éŸ³æ¨‚å•Ÿå‹•ä¸­...";
            soundManager.enable();
            els.splashScreen.style.opacity = '0';
            setTimeout(() => {
                els.splashScreen.remove();
                document.getElementById('icon-sound-off').classList.add('hidden');
                document.getElementById('icon-sound-on').classList.remove('hidden');
                const saved = localStorage.getItem(CONFIG.storageKey);
                if (!saved) openModal(els.modalSetup);
                else tutorialManager.checkFirstTime();
            }, 800);
        };

        document.getElementById('btn-setup-random').onclick = () => {
            soundManager.playClick();
            const pool = Array.from({length: CONFIG.numberRange}, (_, i) => i + 1);
            state.grid = pool.sort(() => Math.random() - 0.5).slice(0, 25);
            completeSetup();
        };

        document.getElementById('btn-setup-manual').onclick = () => {
            soundManager.playClick();
            closeModal(els.modalSetup);
            initManualGrid();
            openModal(els.modalManual);
        };

        function completeSetup() {
            state.markedIndices = [];
            state.completedMissions = [];
            state.claimedLines = 0;
            saveState();
            renderGrid();
            updateStats();
            closeModal(els.modalSetup);
            closeModal(els.modalManual);
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            soundManager.playSuccess();
            tutorialManager.checkFirstTime();
        }

        function initManualGrid() {
            els.manualGrid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.inputMode = 'numeric';
                input.className = 'manual-input-cell';
                input.placeholder = '-';
                input.dataset.index = i;
                input.oninput = (e) => handleManualInput(e.target);
                input.onkeydown = (e) => handleManualKeyDown(e);
                els.manualGrid.appendChild(input);
            }
            validateManualGrid();
        }

        function handleManualInput(input) {
            const val = input.value;
            if (val.length > 2) input.value = val.slice(0, 2);
            if (val.length >= 1 && parseInt(val) >= 1 && parseInt(val) <= CONFIG.numberRange) {
                const next = input.nextElementSibling;
                if (next) next.focus();
            }
            validateManualGrid();
        }

        function handleManualKeyDown(e) {
            if (e.key === 'Backspace' && !e.target.value) {
                const prev = e.target.previousElementSibling;
                if (prev) prev.focus();
            }
        }

        function validateManualGrid() {
            const inputs = Array.from(els.manualGrid.querySelectorAll('input'));
            const values = inputs.map(i => i.value ? parseInt(i.value) : null);
            let duplicates = [];
            let outOfRange = false;
            values.forEach((v, idx) => {
                inputs[idx].classList.remove('duplicate');
                if (v !== null) {
                    if (v < 1 || v > CONFIG.numberRange) outOfRange = true;
                    if (values.filter(x => x === v).length > 1) {
                        duplicates.push(v);
                        inputs[idx].classList.add('duplicate');
                    }
                }
            });
            const uniqueValues = new Set(values.filter(v => v !== null));
            const isComplete = uniqueValues.size === 25 && !outOfRange;
            els.manualConfirm.disabled = !isComplete;
            if (duplicates.length > 0) els.manualValidation.innerText = 'æ•¸å­—ä¸èƒ½é‡è¤‡ï¼';
            else if (outOfRange) els.manualValidation.innerText = `æ•¸å­—å¿…é ˆåœ¨ 1-${CONFIG.numberRange} ä¹‹é–“`;
            else els.manualValidation.innerText = '';
        }

        document.getElementById('btn-manual-autofill').onclick = () => {
            soundManager.playClick();
            const inputs = Array.from(els.manualGrid.querySelectorAll('input'));
            const currentValues = new Set(inputs.map(i => i.value ? parseInt(i.value) : null).filter(v => v !== null));
            const available = Array.from({length: CONFIG.numberRange}, (_, i) => i + 1).filter(v => !currentValues.has(v));
            available.sort(() => Math.random() - 0.5);
            inputs.forEach(input => {
                if (!input.value || input.classList.contains('duplicate')) {
                    if (available.length > 0) input.value = available.pop();
                }
            });
            validateManualGrid();
        };

        document.getElementById('btn-manual-clear').onclick = () => {
            soundManager.playClick();
            els.manualGrid.querySelectorAll('input').forEach(i => i.value = '');
            validateManualGrid();
        };

        els.manualConfirm.onclick = () => {
            soundManager.playClick();
            state.grid = Array.from(els.manualGrid.querySelectorAll('input')).map(i => parseInt(i.value));
            completeSetup();
        };

        function toggleScenicMode(enable) {
            document.body.classList.toggle('scenic-mode', enable);
            soundManager.playClick();
        }
        els.toggleScenic.onclick = () => toggleScenicMode(true);
        els.exitScenic.onclick = () => toggleScenicMode(false);
        els.toggleSound.onclick = () => {
            const isEnabled = soundManager.toggle();
            document.getElementById('icon-sound-off').classList.toggle('hidden', isEnabled);
            document.getElementById('icon-sound-on').classList.toggle('hidden', !isEnabled);
            soundManager.playClick();
        };
        els.btnHelp.onclick = () => tutorialManager.start();
        document.getElementById('open-missions-btn').onclick = () => { soundManager.playClick(); renderMissionList(); openModal(els.modalMissions); };
        document.getElementById('tab-missions').onclick = () => { soundManager.playClick(); state.currentView = 'missions'; renderMissionList(); };
        document.getElementById('tab-guide').onclick = () => { soundManager.playClick(); state.currentView = 'guide'; renderMissionList(); };
        els.categoryFilter.onclick = (e) => { const btn = e.target.closest('.category-btn'); if (btn) { soundManager.playClick(); state.currentFilter = btn.dataset.category; renderMissionList(); } };
        document.getElementById('close-mission-btn').onclick = () => closeModal(els.modalMissions);
        document.getElementById('cancel-input-btn').onclick = () => closeModal(els.modalInput);

        document.getElementById('submit-input-btn').onclick = () => {
            soundManager.playClick();
            const needsPin = currentMission.type === 'staff_number';
            if (needsPin && els.staffPinField.value !== SECURITY.STAFF_PIN) {
                alert("é€šè¡Œç¢¼éŒ¯èª¤ï¼"); return;
            }

            // Reward Logic: Generate numbers based on difficulty
            const count = currentMission.difficulty || 1;
            const drawnNumbers = [];
            const pool = Array.from({length: CONFIG.numberRange}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            
            // Pick 'count' unique numbers
            for (let i = 0; i < count; i++) {
                drawnNumbers.push(pool[i]);
            }

            closeModal(els.modalInput);
            
            // Apply animation then close mission modal
            const card = document.querySelector(`[data-mission-id="${currentMission.id}"]`);
            if (card) card.classList.add('mission-complete-anim');
            
            setTimeout(() => {
                closeModal(els.modalMissions);
                showResultModal(drawnNumbers);
            }, 500);
        };

        function showResultModal(numbers) {
            const resultCard = document.getElementById('result-card');
            const resultText = document.getElementById('result-context-text');
            const resultNumber = document.getElementById('result-number-display');
            const resultActions = document.getElementById('result-actions');
            const burstRays = document.getElementById('burst-rays');
            const closeBtn = document.getElementById('close-result-btn');

            // Reset UI
            resultCard.classList.remove('card-enter-anim', 'animate-float');
            resultNumber.classList.remove('stamp-reveal');
            burstRays.style.opacity = '0';
            resultCard.style.opacity = '0';
            resultCard.style.transform = 'scale(0.8)';
            resultText.style.opacity = '0';
            resultNumber.style.opacity = '0';
            resultActions.style.opacity = '0';
            closeBtn.style.pointerEvents = 'none';

            // Set Content
            resultText.innerText = currentMission.success_text || "ä¸€æ®µç¾å¥½çš„å±±æ—è¨˜æ†¶ï¼Œå·²æ‚„æ‚„æ”¶è—...";
            
            // Formatting for multiple numbers
            if (numbers.length > 1) {
                resultNumber.style.fontSize = numbers.length === 3 ? '2.5rem' : '3.5rem';
                resultNumber.innerText = numbers.map(n => `NO.${n}`).join("\n");
            } else {
                resultNumber.style.fontSize = '5rem';
                resultNumber.innerText = numbers[0];
            }
            
            openModal(els.modalResult);
            soundManager.playReveal();
            
            // Animations
            setTimeout(() => burstRays.style.opacity = '1', 100);
            setTimeout(() => {
                resultCard.classList.add('card-enter-anim');
                setTimeout(() => resultCard.classList.add('animate-float'), 800);
            }, 500);
            setTimeout(() => resultText.style.opacity = '1', 800);
            
            // Process Results Logic
            setTimeout(() => {
                resultNumber.style.opacity = '1';
                resultNumber.classList.add('stamp-reveal');
                
                let foundMatch = false;
                numbers.forEach(num => {
                    const idx = state.grid.indexOf(num);
                    if (idx !== -1 && !state.markedIndices.includes(idx)) {
                        state.markedIndices.push(idx);
                        foundMatch = true;
                    }
                });
                
                if (!state.completedMissions.includes(currentMission.id)) {
                    state.completedMissions.push(currentMission.id);
                }
                
                saveState();
                renderGrid();
                updateStats();
                
                if (foundMatch) {
                    setTimeout(() => {
                        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#D4AF37', '#FDFBF7'] });
                        soundManager.playSuccess();
                    }, 100);
                }
            }, 1500);

            setTimeout(() => {
                resultActions.style.opacity = '1';
                closeBtn.style.pointerEvents = 'auto';
            }, 2200);
        }

        document.getElementById('close-result-btn').onclick = () => {
            soundManager.playClick();
            closeModal(els.modalResult);
            setTimeout(() => document.getElementById('burst-rays').style.opacity = '0', 300);
        };

        function handleUserSelection(idx) {
            soundManager.playClick();
            if (confirm(`ç¢ºå®šåœ¨ä½ç½® ${idx+1} å¡«å…¥è™Ÿç¢¼ ${state.grid[idx]} å—ï¼Ÿ`)) {
                state.markedIndices.push(idx);
                state.completedMissions.push(currentMission.id);
                state.isSelectionMode = false;
                saveState(); renderGrid(); updateStats();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
                soundManager.playSuccess();
            }
        }

        loadState();
    </script>
</body>
</html>