<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ„›ä¸Šå–œç¿ | å±±æ—æ‹¾å…‰æ”¶é›†å†Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --color-mountain: #2C3E50;
            --color-gold: #B8860B;
            --color-gold-light: #D4AF37;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
        }

        body {
            font-family: 'Noto Serif TC', serif;
            color: var(--color-mountain);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            background-image: url('https://i.ibb.co/23KWDLjy/597488410-25468436916138867-3479504377125617703-n.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-color: #1a202c;
            transition: background-color 0.8s ease;
        }

        .bg-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(2px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scenic-mode .bg-overlay {
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            border-radius: 1.5rem;
        }

        .memory-frame {
            aspect-ratio: 1;
            background-color: #FDFBF7;
            border: 4px solid #FFFFFF;
            border-radius: 0.25rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .memory-frame:not(.collected):active,
        .memory-frame:not(.collected):hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 10;
        }

        .memory-frame.collected {
            background: linear-gradient(to bottom, #1e1b4b, #312e81);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
            z-index: 5;
        }

        .particle-star {
            position: absolute;
            background-color: #FFF;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.8), 0 0 8px rgba(253, 224, 71, 0.6);
            pointer-events: none;
            opacity: 0;
            will-change: opacity, transform;
            animation: particle-twinkle linear infinite;
        }

        @keyframes particle-twinkle {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0.3); }
        }

        .memory-frame.collected::after {
            content: "";
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 40%;
            background: #020617;
            clip-path: polygon(0% 100%, 0% 40%, 20% 70%, 45% 20%, 70% 60%, 100% 10%, 100% 100%);
            z-index: 2;
            opacity: 0.9;
        }

        .memory-frame.collected .cell-content {
            position: relative;
            z-index: 10;
            animation: firefly-breathe 3s infinite ease-in-out alternate;
        }
        
        .bingo-number {
            color: #8B7355;
            transition: color 0.3s ease;
        }
        .memory-frame.collected .bingo-number {
            color: #FDE047;
            text-shadow: 0 0 15px rgba(253, 224, 71, 0.6);
        }
        .memory-frame.bingo-line-glow .bingo-number {
            color: #451a03 !important;
            transform: scale(1.1);
        }

        .memory-frame.bingo-line-glow {
            background: linear-gradient(135deg, #FFD700 0%, #FFF8DC 100%) !important;
            border: 4px solid #FFD700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8) !important;
            animation: bingo-shimmer 2s infinite ease-in-out !important;
            z-index: 20;
        }
        
        .memory-frame.bingo-line-glow .cell-content {
            animation: none !important;
            transform: scale(1.05);
        }

        .memory-frame.bingo-line-glow::after, 
        .memory-frame.bingo-line-glow .particle-star {
            display: none !important;
        }

        @keyframes bingo-shimmer {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.2); }
        }

        @keyframes firefly-breathe {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.05); opacity: 1; }
        }

        .selection-mode .memory-frame:not(.collected) {
            cursor: pointer;
            border-color: var(--color-gold);
            animation: pulse-paper 2s infinite;
            z-index: 10;
        }

        @keyframes pulse-paper {
            0% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(184, 134, 11, 0.2); }
            50% { transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(184, 134, 11, 0.4); }
            100% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(184, 134, 11, 0.2); }
        }

        @keyframes slide-out-right {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(50px); opacity: 0; }
        }
        .mission-complete-anim {
            animation: slide-out-right 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
        }

        .btn-gold-gradient {
            background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728);
            background-size: 200% auto;
            transition: all 0.5s ease;
        }
        .btn-gold-gradient:hover {
            background-position: right center;
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(212,175,55,0.6);
        }
        .btn-gold-gradient:active {
            transform: scale(0.98);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .modal-enter { transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1); }
        .modal-enter-active { transform: translateY(0); }

        .manual-input-cell {
            aspect-ratio: 1;
            text-align: center;
            font-size: 1.25rem;
            font-family: 'Noto Serif TC', serif;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            background: #FFF;
            transition: all 0.2s;
        }
        .manual-input-cell:focus {
            outline: none;
            border-color: var(--color-gold);
            box-shadow: 0 0 0 2px rgba(184, 134, 11, 0.1);
        }
        .manual-input-cell.duplicate {
            border-color: #EF4444;
            background-color: #FEF2F2;
            color: #EF4444;
        }

        .category-btn {
            background: rgba(255, 255, 255, 0.05);
            color: #94A3B8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            white-space: nowrap;
        }
        .category-btn.active {
            background: #D4AF37 !important;
            color: #1a202c !important; 
            font-weight: bold;
            border: 1px solid #D4AF37;
            box-shadow: 0 0 15px rgba(212,175,55,0.4);
        }

        .game-ui { transition: opacity 0.6s ease, transform 0.6s ease; }
        .scenic-mode .game-ui { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .scenic-mode .fixed-action-btn { opacity: 0; pointer-events: none; }
        #scenic-return-hint { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        .scenic-mode #scenic-return-hint { opacity: 1; pointer-events: auto; }
        #exit-scenic-btn { pointer-events: none; }
        .scenic-mode #exit-scenic-btn { pointer-events: auto; }
        
        .header-btn { padding: 0.5rem; color: rgba(255, 255, 255, 0.8); transition: all 0.2s; }
        .header-btn:hover { color: #D4AF37; opacity: 1; }
        .header-btn:active { transform: scale(0.9); }
        
        .track-item.active { border-color: #D4AF37; background-color: rgba(212, 175, 55, 0.1); }
        .track-item.active .track-icon { transform: scale(1.1); }

        .bonfire-container { position: relative; width: 220px; height: 220px; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
        .bonfire-logs { position: absolute; bottom: 20px; width: 120px; height: 30px; background: #5C4033; border-radius: 10px; z-index: 10; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }
        .bonfire-logs::before { content: ''; position: absolute; transform: rotate(25deg); width: 100%; height: 100%; background: #4A332A; border-radius: 10px; }
        .bonfire-logs::after { content: ''; position: absolute; transform: rotate(-25deg); width: 100%; height: 100%; background: #3E2B23; border-radius: 10px; }

        .bonfire-flame {
            position: absolute; bottom: 40px; width: 60px; height: 60px;
            border-radius: 50% 0 50% 50%;
            background: radial-gradient(circle at 50% 80%, #FFD700, #FF4500);
            transform: rotate(-45deg) scale(1);
            filter: blur(5px); opacity: 0.9;
            animation: flame-burn 1.5s infinite ease-in-out alternate;
            z-index: 5;
        }
        .bonfire-flame:nth-child(2) {
            width: 45px; height: 45px; bottom: 45px; left: 90px;
            background: radial-gradient(circle at 50% 80%, #FFA500, #FF0000);
            animation-duration: 1.2s; animation-delay: 0.2s;
        }
        .bonfire-flame:nth-child(3) {
            width: 70px; height: 70px; bottom: 35px; left: 75px;
            background: radial-gradient(circle at 50% 80%, #FFFFE0, #FF8C00);
            animation-duration: 1.8s; animation-delay: 0.5s;
        }
        
        .bonfire-glow {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 150px; height: 50px;
            background: radial-gradient(ellipse at center, rgba(255,69,0,0.6), transparent 70%);
            filter: blur(10px); animation: glow-pulse 2s infinite;
        }

        @keyframes flame-burn {
            0% { transform: rotate(-45deg) scale(1) translateY(0); border-radius: 50% 0 50% 50%; }
            50% { transform: rotate(-45deg) scale(1.1) translateY(-5px); border-radius: 50% 5% 50% 50%; }
            100% { transform: rotate(-45deg) scale(0.95) translateY(2px); border-radius: 40% 0 40% 40%; }
        }
        @keyframes glow-pulse {
            0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.9; transform: translateX(-50%) scale(1.1); }
        }

        .pinecone-projectile { position: absolute; bottom: -50px; left: 50%; font-size: 3rem; z-index: 50; opacity: 0; pointer-events: none; }
        .animate-toss { animation: toss-arc 0.8s forwards ease-in; }
        @keyframes toss-arc {
            0% { bottom: -50px; transform: translateX(-50%) scale(1) rotate(0deg); opacity: 1; }
            50% { bottom: 100px; transform: translateX(-50%) scale(0.8) rotate(180deg); opacity: 1; }
            100% { bottom: 60px; transform: translateX(-50%) scale(0.2) rotate(360deg); opacity: 0; }
        }

        .bonfire-flare .bonfire-flame { animation: flare-boom 0.6s forwards ease-out; }
        @keyframes flare-boom {
            0% { transform: rotate(-45deg) scale(1); filter: brightness(1) blur(5px); }
            20% { transform: rotate(-45deg) scale(0.5); filter: brightness(2) blur(2px); }
            50% { transform: rotate(-45deg) scale(2.5); filter: brightness(3) hue-rotate(180deg) blur(10px); opacity: 1; }
            100% { transform: rotate(-45deg) scale(1); filter: brightness(1) blur(5px); }
        }

        .tutorial-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44, 62, 80, 0.85); z-index: 60; opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .tutorial-active .tutorial-overlay { opacity: 1; pointer-events: auto; }
        .tutorial-highlight {
            position: relative; z-index: 70 !important;
            box-shadow: 0 0 0 4px #D4AF37, 0 0 40px rgba(0,0,0,0.5) !important;
            transition: all 0.3s ease; background-color: #FFF;
        }
        .glass-card.tutorial-highlight { background: #FFF; }
        .tutorial-card {
            position: fixed; left: 50%; transform: translateX(-50%); width: 90%; max-width: 360px;
            background: #FFF; border: 1px solid #D4AF37; border-radius: 1rem; padding: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 80;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); opacity: 0; pointer-events: none;
        }
        .tutorial-active .tutorial-card { opacity: 1; pointer-events: auto; }
        .tutorial-card.position-bottom { bottom: 2rem; }
        .tutorial-card.position-top { top: 2rem; }
        .tutorial-card.position-center { top: 50%; transform: translate(-50%, -50%); }

        .dot-indicator { width: 8px; height: 8px; border-radius: 50%; background: #E2E8F0; transition: all 0.3s; }
        .dot-indicator.active { background: #D4AF37; width: 20px; border-radius: 4px; }
        
        .sunburst-rays {
            background: repeating-conic-gradient(from 0deg, rgba(212, 175, 55, 0.4) 0deg 10deg, transparent 10deg 20deg);
            animation: rotate-slow 20s linear infinite;
            mask-image: radial-gradient(circle, black 0%, transparent 70%);
            -webkit-mask-image: radial-gradient(circle, black 0%, transparent 70%);
        }
        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .paper-texture {
            background-color: #FDFBF7;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            box-shadow: inset 0 0 40px rgba(0,0,0,0.05), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #D4AF37;
        }

        @keyframes float-card { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .animate-float { animation: float-card 6s ease-in-out infinite; }

        @keyframes stamp-in-bounce {
            0% { transform: scale(3); opacity: 0; }
            50% { transform: scale(0.9); opacity: 1; }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .stamp-reveal { animation: stamp-in-bounce 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes scale-in-fade { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .card-enter-anim { animation: scale-in-fade 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards; }

        #splash-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(to bottom, #1a2a6c, #2C3E50);
            display: flex; flex-col: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }

        #mission-content {
            background-color: #0F172A !important;
            background-image: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%) !important;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; color: #F1F5F9;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: background 0.3s;
        }
        
        .tab-btn { color: #94A3B8; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #FCD34D; border-bottom: 2px solid #FCD34D; background: rgba(253, 224, 71, 0.05); }

        #mission-grid::-webkit-scrollbar { width: 4px; }
        #mission-grid::-webkit-scrollbar-track { background: transparent; }
        #mission-grid::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        
        .phantom-line { stroke: rgba(255, 255, 255, 0.2); stroke-width: 1; fill: none; stroke-dasharray: 4; }
        
        .active-line {
            stroke: #D4AF37; stroke-width: 2; fill: none;
            filter: drop-shadow(0 0 3px rgba(253, 224, 71, 0.5));
            animation: draw-line 1.5s ease-out forwards;
        }
        @keyframes draw-line { from { stroke-dashoffset: 1000; stroke-dasharray: 1000; } to { stroke-dashoffset: 0; stroke-dasharray: 1000; } }

        @keyframes fillPulse {
            0% { opacity: 0.6; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); }
            50% { opacity: 0.9; filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.9)); }
            100% { opacity: 0.6; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); }
        }

        .energy-shape {
            fill: rgba(255, 223, 0, 0.5); stroke: #D4AF37; stroke-width: 2px;
            animation: fillPulse 4s infinite ease-in-out; pointer-events: none;
        }

        @keyframes starPulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 2px gold); }
            50% { transform: scale(1.3); filter: drop-shadow(0 0 8px gold); }
            100% { transform: scale(1); filter: drop-shadow(0 0 2px gold); }
        }
        
        .star-point { fill: #FFF; transition: all 0.3s; cursor: pointer; }
        .star-point:hover { transform: scale(1.5); fill: #FCD34D; }
        .star-unlocked { fill: #D4AF37; animation: starPulse 2s infinite ease-in-out; transform-origin: center; transform-box: fill-box; }
        
        @keyframes wingFlap { 0%, 100% { transform: rotate(0deg) translateY(0); } 50% { transform: rotate(-5deg) translateY(-10px); } }
        .animate-wings { animation: wingFlap 3s infinite ease-in-out; transform-origin: 40% 30%; }

        @keyframes legGallop { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } }
        .animate-legs { animation: legGallop 1.5s infinite linear; transform-origin: center top; transform-box: fill-box; }

        @keyframes pegasusGallopAcross {
            0% { transform: translateX(-100%) scale(0.8); opacity: 0; }
            20% { opacity: 1; }
            80% { transform: translateX(0%) scale(1); opacity: 1; }
            100% { transform: translateX(20%) scale(1.1); opacity: 0; }
        }
        .pegasus-finale-anim { animation: pegasusGallopAcross 4s forwards ease-in-out; }
        
        .pegasus-tooltip {
            position: absolute; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(253, 224, 71, 0.3);
            color: #F1F5F9; padding: 6px 10px; border-radius: 6px; font-size: 12px;
            pointer-events: none; opacity: 0; transform: translateY(10px); transition: all 0.2s; z-index: 50;
        }
        .pegasus-tooltip.visible { opacity: 1; transform: translateY(0); }

        #bingo-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100;
            background: rgba(44, 24, 16, 0.95); backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.5); padding: 1.5rem 3rem; border-radius: 9999px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            opacity: 0; pointer-events: none;
        }
        #bingo-toast.active { opacity: 1; transform: translate(-50%, -60%); }
    </style>
</head>
<body class="flex flex-col items-center p-4 overflow-x-hidden">

    <div class="bg-overlay"></div>
    <audio id="bgm-audio" loop preload="auto" playsinline style="position:absolute; width:0; height:0; opacity:0; pointer-events:none;"></audio>

    <div id="splash-screen">
        <div class="text-center p-8 space-y-6 max-w-md animate-fade-in">
            <h1 class="text-5xl font-bold text-[#D4AF37] tracking-widest mb-2 font-serif drop-shadow-lg">æ„›ä¸Šå–œç¿</h1>
            <p class="text-xl text-white/90 tracking-wider font-light border-b border-white/20 pb-4 inline-block">å±±æ—æ‹¾å…‰æ”¶é›†å†Š</p>
            <div class="text-sm text-gray-300 leading-relaxed mt-4">
                <p>é–‹å•ŸéŸ³æ¨‚ï¼Œäº«å—æ²‰æµ¸å¼å±±æ—é«”é©—</p>
            </div>
            <button id="splash-start-btn" class="mt-8 px-10 py-4 bg-[#D4AF37] hover:bg-[#F0E68C] text-[#1a2a6c] rounded-full font-bold tracking-widest shadow-[0_0_30px_rgba(212,175,55,0.4)] transition-all active:scale-95 text-lg">
                ğŸŒ² é–‹å§‹é«”é©—
            </button>
            <p id="audio-status" class="text-xs text-gray-500 mt-4 min-h-[20px]">ğŸµ éŸ³æ¨‚æº–å‚™å°±ç·’</p>
        </div>
    </div>

    <div id="tutorial-overlay" class="tutorial-overlay"></div>
    <div id="tutorial-card" class="tutorial-card position-center">
        <h3 id="tut-title" class="text-xl font-bold text-[#2C3E50] mb-2 font-serif tracking-widest"></h3>
        <p id="tut-desc" class="text-sm text-[#64748B] mb-6 leading-relaxed"></p>
        <div class="flex items-center justify-between">
            <div id="tut-dots" class="flex gap-1.5"></div>
            <div class="flex gap-2">
                <button id="tut-skip" class="text-gray-400 text-sm px-4 py-3 hover:text-gray-600 transition-colors">è·³é</button>
                <button id="tut-next" class="bg-[#2C3E50] text-white px-5 py-2 rounded-lg text-sm shadow-lg tracking-widest active:scale-95 transition-transform">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
    </div>

    <div id="scenic-return-hint" class="fixed inset-0 z-[100] flex flex-col items-center justify-end pb-12 pointer-events-none">
        <button id="exit-scenic-btn" class="bg-white/20 backdrop-blur-md border border-white/40 text-white px-8 py-3 rounded-full text-sm tracking-[0.3em] shadow-2xl active:scale-95 transition-transform">
            é»æ“Šè¿”å›æ”¶é›†å†Š
        </button>
    </div>

    <div id="bonfire-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-lg transition-opacity duration-300 opacity-0">
        <div class="w-full max-w-sm flex flex-col items-center relative">
            <h3 class="text-3xl text-[#D4AF37] tracking-[0.3em] font-serif mb-2 drop-shadow-[0_0_10px_rgba(212,175,55,0.8)]">ç‡Ÿç«è¨±é¡˜</h3>
            <p class="text-xs text-orange-200/70 tracking-wider mb-8 text-center">æŠ•å…¥æ¾æœï¼Œè®“ç«ç„°ç‚ºä½ å¸¶ä¾†å±±æ—çš„é¥‹è´ˆ</p>
            <div class="bonfire-container mb-8" id="bonfire-wrapper">
                <div class="bonfire-glow"></div>
                <div class="bonfire-logs"></div>
                <div class="bonfire-flame"></div>
                <div class="bonfire-flame"></div>
                <div class="bonfire-flame"></div>
                <div id="pinecone-projectile" class="pinecone-projectile">ğŸŒ²</div>
            </div>
            <div id="bonfire-result-msg" class="text-[#FFD700] font-bold text-xl h-12 mb-2 flex items-center justify-center text-center leading-tight drop-shadow-md opacity-0 transition-opacity duration-500"></div>
            <div class="flex gap-4 w-full mt-6">
                <button id="close-bonfire-btn" class="flex-1 py-3 text-white/50 text-sm font-medium border border-white/10 rounded-full">ç¨å¾Œå†ä¾†</button>
                <button id="toss-pinecone-btn" class="flex-[2] bg-gradient-to-r from-[#D35400] to-[#E67E22] text-white py-3 rounded-full text-sm tracking-widest shadow-[0_0_20px_rgba(230,126,34,0.4)] active:scale-95 transition-all font-bold flex items-center justify-center gap-2">
                    <span>ğŸ”¥ æŠ•å…¥æ¾æœ</span>
                </button>
            </div>
        </div>
    </div>

    <div id="bingo-toast">
        <span class="text-[#D4AF37] font-bold tracking-[0.3em] text-lg whitespace-nowrap">âœ¨ æ˜Ÿå…‰é€£ç·šï¼æ‹¾å…‰è§£é– âœ¨</span>
    </div>

    <div id="app" class="relative z-10 w-full max-w-md flex flex-col min-h-[90vh]">
        
        <header class="pt-8 pb-4 text-center relative game-ui">
            <div class="absolute top-8 right-0 flex gap-2">
                <button id="music-menu-btn" class="header-btn" title="åˆ‡æ›èƒŒæ™¯éŸ³æ¨‚">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18V5l12-2v13" stroke-linecap="round" stroke-linejoin="round"/><circle cx="6" cy="18" r="3" stroke-linecap="round" stroke-linejoin="round"/><circle cx="18" cy="16" r="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button id="toggle-sound-btn" class="header-btn" title="éŸ³æ¨‚é–‹é—œ">
                    <svg id="icon-sound-off" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>
                    <svg id="icon-sound-on" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                </button>
                <button id="toggle-scenic-btn" class="header-btn" title="è§€è³èƒŒæ™¯">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                </button>
                <button id="help-btn" class="header-btn" title="éŠæˆ²èªªæ˜">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
            </div>
            
            <div class="inline-flex flex-col items-center">
                <span class="text-[#D4AF37] text-xs tracking-[0.3em] uppercase mb-2 font-medium drop-shadow">Love Hsiung</span>
                <h1 class="text-4xl font-medium text-white tracking-widest mb-1 drop-shadow-lg font-serif">æ„›ä¸Šå–œç¿</h1>
                <div class="h-[1px] w-12 bg-[#D4AF37] my-3"></div>
                <h2 class="text-xl text-gray-200 tracking-[0.15em] font-light drop-shadow-md">å±±æ—æ‹¾å…‰æ”¶é›†å†Š</h2>
            </div>
        </header>

        <main class="flex-1 px-2 flex flex-col items-center relative game-ui">
            <div id="spin-area" class="w-full flex justify-between items-center px-4 mb-4 mt-2 bg-white/10 backdrop-blur rounded-lg py-2 transition-all border border-white/20">
                <div class="text-xs text-gray-100 tracking-wide">
                    é”æˆé€£ç·šï¼š<span id="total-lines" class="font-bold text-[#D4AF37] text-sm">0</span>
                </div>
                <button id="enter-bonfire-btn" class="hidden flex items-center gap-2 bg-gradient-to-r from-[#5D4037] to-[#3E2723] text-white px-4 py-2 rounded-full shadow-lg border border-[#E67E22]/50 active:scale-95 transition-all">
                    <span class="text-lg">ğŸ”¥</span>
                    <span class="text-xs tracking-widest font-bold">ç‡Ÿç«è¨±é¡˜ x<span id="pinecones-available">0</span></span>
                </button>
            </div>

            <div id="selection-banner" class="hidden w-full mb-6 animate-bounce z-20 pointer-events-none text-center">
                <div class="bg-gradient-to-r from-[#B8860B] to-[#D4AF37] text-white py-3 px-6 rounded-full shadow-xl text-sm tracking-widest font-bold border border-white/30 inline-block pointer-events-auto">
                    âœ¨ é»ƒé‡‘æ™‚åˆ»ï¼šè«‹é»æ“Šä»»ä¸€è³“æœæ ¼ âœ¨
                </div>
            </div>

            <div class="w-full flex justify-between items-end px-4 mb-3 mt-1">
                <span class="text-sm text-white font-medium tracking-wider drop-shadow-md">æˆ‘çš„å›æ†¶æ‹¼åœ–</span>
                <div class="flex items-baseline gap-1">
                    <span id="progress-text" class="text-2xl font-serif text-[#FCD34D] font-bold drop-shadow-sm">0</span>
                    <span class="text-sm text-gray-300">/ 25</span>
                </div>
            </div>

            <div class="glass-card p-4 rounded-[1.5rem] w-full shadow-2xl transition-transform duration-500" id="grid-card">
                <div id="grid-container" class="grid grid-cols-5 gap-2 w-full"></div>
            </div>

            <div class="mt-8 text-center px-6 pb-24">
                <p class="text-sm text-white/80 font-medium leading-loose italic tracking-wide drop-shadow-sm">
                    ã€Œæ¯ä¸€æ­¥è¶³è·¡ï¼Œ<br/>éƒ½æ˜¯å¯«çµ¦å¤§è‡ªç„¶çš„æƒ…æ›¸ã€‚ã€
                </p>
            </div>
        </main>

        <div id="main-action-area" class="fixed bottom-8 left-0 right-0 z-30 px-6 flex justify-center fixed-action-btn">
            <button id="open-missions-btn" class="w-full max-w-md btn-gold-gradient rounded-full shadow-2xl active:scale-95 border-2 border-white/20">
                <div class="relative py-4 flex items-center justify-center gap-3 text-[#2C3E50]">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    <span class="text-lg tracking-[0.2em] font-bold">é–‹å•Ÿæ¢éšªæ‰‹å†Š</span>
                </div>
            </button>
        </div>

        <!-- MODALS -->
        <div id="music-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/60 backdrop-blur-md transition-all duration-300 opacity-0">
            <div class="bg-white/95 w-full max-w-xs rounded-2xl p-6 shadow-2xl border border-white/50 modal-enter">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg text-[#2C3E50] font-medium tracking-wide">é¸æ“‡æ°›åœéŸ³æ¨‚</h3>
                    <button id="close-music-btn" class="text-gray-400 p-1 hover:text-[#2C3E50]"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg></button>
                </div>
                <div id="track-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="setup-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/80 backdrop-blur-md transition-opacity duration-300 opacity-0">
            <div class="bg-white/95 w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-white/60">
                <div class="text-center mb-6">
                    <h3 class="text-2xl text-[#2C3E50] tracking-widest font-medium mb-2">æº–å‚™æ‚¨çš„æ¢éšªåœ°åœ–</h3>
                    <p class="text-xs text-[#64748B] tracking-wider">è«‹é¸æ“‡è³“æœå¡ç‰‡æ•¸å­—çš„ç”¢ç”Ÿæ–¹å¼</p>
                </div>
                <div class="flex flex-col gap-4">
                    <button id="btn-setup-random" class="w-full py-4 bg-[#2C3E50] text-white rounded-xl shadow-lg active:scale-95 transition-all">éš¨æ©Ÿç”Ÿæˆ (1-30)</button>
                    <button id="btn-setup-manual" class="w-full py-4 border-2 border-[#2C3E50] text-[#2C3E50] rounded-xl shadow-sm active:scale-95 transition-all font-medium">æ‰‹å‹•å¡«å¯«</button>
                </div>
            </div>
        </div>

        <div id="manual-setup-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/90 backdrop-blur-lg transition-opacity duration-300 opacity-0">
            <div class="bg-[#FDFBF7] w-full max-w-md rounded-3xl p-6 shadow-2xl border border-white/50 flex flex-col h-[90vh] sm:h-auto">
                <div class="text-center mb-6 shrink-0">
                    <h3 class="text-2xl text-[#2C3E50] tracking-widest font-medium">ç·¨æ’å›æ†¶åœ°åœ–</h3>
                    <p class="text-xs text-[#8B7355] mt-1">è«‹åœ¨ 1-30 çš„ç©ºæ ¼ä¸­å¡«å…¥æ‚¨å¿ƒå„€çš„å¹¸é‹æ•¸å­—</p>
                </div>
                <div id="manual-input-grid" class="grid grid-cols-5 gap-2 flex-1 overflow-y-auto py-2 no-scrollbar"></div>
                <div class="mt-6 flex flex-col gap-3 shrink-0">
                    <div id="manual-validation-msg" class="text-center text-xs text-red-500 h-4 font-medium"></div>
                    <div class="flex gap-2">
                        <button id="btn-manual-autofill" class="flex-1 py-3 bg-white border border-[#D4AF37] text-[#B8860B] rounded-xl text-sm font-medium shadow-sm active:scale-95 transition-all">éš¨æ©Ÿè£œå®Œ</button>
                        <button id="btn-manual-clear" class="px-4 py-3 bg-gray-100 text-gray-500 rounded-xl text-sm active:scale-95 transition-all">æ¸…ç©º</button>
                    </div>
                    <button id="btn-manual-confirm" class="w-full py-4 bg-[#2C3E50] text-white rounded-xl shadow-lg active:scale-95 transition-all font-bold tracking-[0.2em] disabled:opacity-50 disabled:cursor-not-allowed">é–‹å§‹å±±æ—å†’éšª</button>
                </div>
            </div>
        </div>

        <div id="mission-modal" class="fixed inset-0 z-40 hidden flex items-end sm:items-center justify-center sm:p-4 bg-[#2C3E50]/40 backdrop-blur-sm transition-all duration-300 opacity-0">
            <div id="mission-content" class="w-full max-w-sm h-[80vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl rounded-t-3xl p-0 shadow-2xl modal-enter flex flex-col overflow-hidden relative">
                <div class="p-6 pb-4 border-b border-gray-700/50 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-2xl text-[#FCD34D] tracking-widest font-serif font-bold mission-modal-title">æˆ‘çš„å±±æ—æ‹¾å…‰</h3>
                        <p class="text-xs text-gray-400 mt-1 tracking-wider mission-modal-subtitle">Love Hsiung Collection</p>
                    </div>
                    <button id="close-mission-btn" class="text-gray-300 p-2 bg-gray-700/50 rounded-full hover:bg-gray-600 transition-colors">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg>
                    </button>
                </div>
                <div class="flex border-b border-gray-700/50 shrink-0">
                    <button id="tab-missions" class="flex-1 py-3 text-sm font-medium transition-all tab-btn active">å†’éšªä»»å‹™</button>
                    <button id="tab-guide" class="flex-1 py-3 text-sm font-medium transition-all tab-btn">å¤©é¦¬æ˜Ÿåœ–</button>
                </div>
                
                <div id="view-task-list" class="flex flex-col flex-1 overflow-hidden relative">
                    <div class="px-4 py-3 overflow-x-auto no-scrollbar shrink-0 border-b border-gray-700/30">
                        <div class="flex gap-2 min-w-max" id="category-filter-container">
                            <button class="category-btn active px-4 py-2 rounded-full text-xs category-pill" data-category="all">å…¨éƒ¨</button>
                            <button class="category-btn px-4 py-2 rounded-full text-xs category-pill" data-category="cloud">é›²ä¸Šç”Ÿæ´»</button>
                            <button class="category-btn px-4 py-2 rounded-full text-xs category-pill" data-category="photo">å±±æ—å¯«çœŸ</button>
                            <button class="category-btn px-4 py-2 rounded-full text-xs category-pill" data-category="social_share">é›²ç«¯å¯„æƒ…</button>
                            <button class="category-btn px-4 py-2 rounded-full text-xs category-pill" data-category="explore">ç§˜å¯†æ¢ç´¢</button>
                            <button class="category-btn px-4 py-2 rounded-full text-xs category-pill" data-category="social">ç‡Ÿç«å¾®å…‰</button>
                            <button class="category-btn px-4 py-2 rounded-full text-xs category-pill" data-category="soul">éˆé­‚å°è©±</button>
                            <button class="category-btn px-4 py-2 rounded-full text-xs category-pill" data-category="magic">å¥‡è¹Ÿé­”æ³•</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 no-scrollbar pb-16">
                        <div id="mission-grid" class="grid grid-cols-2 gap-3"></div>
                    </div>
                </div>

                <div id="view-star-map" class="hidden flex-1 w-full h-full relative overflow-hidden bg-[#0B1026] select-none">
                    <div id="pegasus-tooltip" class="pegasus-tooltip"></div>
                    <div id="svg-map-wrapper" class="w-full h-full">
                         <svg id="pegasus-svg" width="100%" height="100%" viewBox="0 0 400 400" preserveAspectRatio="xMidYMid meet" class="w-full h-full">
                              <g id="bg-stars" opacity="0.3"></g>
                              <g id="phantom-lines"></g>
                              <g id="pegasus-body"></g>
                         </svg>
                         <div class="absolute bottom-6 left-0 right-0 text-center pointer-events-none">
                             <p class="text-[#94A3B8] text-[10px] tracking-[0.3em] font-light opacity-80">å®Œæˆåˆ†é¡ä»»å‹™ é»äº®æ˜Ÿåº§</p>
                         </div>
                    </div>
                    
                    <!-- Container for dynamic certificate injection -->
                    <div id="certificate-view" class="hidden w-full h-full"></div>
                </div>
            </div>
        </div>

        <div id="input-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[#2C3E50]/60 backdrop-blur-md transition-all duration-300 opacity-0">
            <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl border border-white/50">
                <div class="text-center mb-6">
                    <span id="input-icon" class="text-4xl mb-4 block animate-bounce"></span>
                    <h3 id="input-title" class="text-xl text-[#2C3E50] mb-2 font-medium tracking-wide"></h3>
                    <p id="input-hint" class="text-xs text-[#64748B] leading-relaxed font-light"></p>
                </div>
                <div class="mb-4" id="staff-pin-container">
                    <label class="block text-xs text-gray-400 mb-1 text-center">å·¥ä½œäººå“¡é€šè¡Œç¢¼</label>
                    <input type="password" id="staff-pin-input" maxlength="4" placeholder="****" class="w-full text-center text-xl tracking-[0.5em] py-2 border-b border-[#E2E8F0] focus:outline-none">
                </div>
                <div class="flex gap-3">
                    <button id="cancel-input-btn" class="flex-1 py-3 text-gray-400 text-sm font-medium">å–æ¶ˆ</button>
                    <button id="submit-input-btn" class="flex-1 bg-[#2C3E50] text-white py-3 rounded-lg text-sm tracking-widest shadow-md active:scale-95 transition-all">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <div id="result-modal" class="fixed inset-0 z-50 hidden">
             <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=2070&auto=format&fit=crop');"></div>
             <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-1000" id="result-bg-overlay"></div>
             <div class="absolute inset-0 flex items-center justify-center overflow-hidden pointer-events-none">
                  <div id="burst-rays" class="sunburst-rays w-[200vmax] h-[200vmax] opacity-0 transition-opacity duration-700"></div> 
             </div>
             <div class="relative z-10 w-full h-full flex flex-col items-center justify-center p-6">
                  <div id="result-card" class="paper-texture w-64 aspect-[3/4] p-6 shadow-2xl relative flex flex-col items-center justify-center text-center opacity-0 transform scale-90 transition-none animate-float rounded-sm">
                       <div class="absolute inset-2 border border-[#D4AF37]/30 pointer-events-none"></div>
                       <div class="z-10 flex flex-col items-center gap-6 w-full">
                           <div id="result-context-text" class="text-[#5C4033] text-sm font-serif italic font-medium leading-loose opacity-0 transition-opacity duration-700"></div>
                           <div class="flex flex-col items-center w-full">
                               <span class="text-[#B8860B] text-[10px] uppercase tracking-[0.2em] mb-1 opacity-60">Memory No.</span>
                               <span id="result-number-display" class="text-2xl text-[#B8860B] font-serif font-bold opacity-0 transform scale-150 transition-none drop-shadow-md break-all leading-tight"></span>
                           </div>
                       </div>
                       <div class="absolute bottom-2 right-2 text-[#D4AF37]/20 text-4xl">â§</div>
                       <div class="absolute top-2 left-2 text-[#D4AF37]/20 text-4xl transform rotate-180">â§</div>
                  </div>
                  <div id="result-actions" class="mt-10 flex flex-col items-center opacity-0 transition-opacity duration-700">
                      <h2 class="text-white/90 text-sm tracking-[0.4em] uppercase mb-6 font-light drop-shadow-lg">å°‹ç²æ‹¾å…‰</h2>
                      <button id="close-result-btn" class="px-12 py-3 border border-[#D4AF37] text-[#D4AF37] hover:bg-[#D4AF37] hover:text-[#2C3E50] rounded-full text-sm transition-all duration-300 backdrop-blur-sm bg-black/20">
                          æ”¶ä¸‹å›æ†¶
                      </button>
                  </div>
             </div>
        </div>

    </div>

    <script>
        const svgNS = "http://www.w3.org/2000/svg";
        const SECURITY = { STAFF_PIN: '1688' };

        const PEGASUS_MAP = {
            photo: { label: 'å±±æ—å¯«çœŸ', points: [{x:85, y:18}, {x:92, y:25}, {x:85, y:30}, {x:80, y:25}] },
            soul: { label: 'éˆé­‚å°è©±', points: [{x:78, y:32}, {x:72, y:40}, {x:68, y:45}] },
            magic: { label: 'å¥‡è¹Ÿèˆ‡é­”æ³•', points: [{x:55, y:40}, {x:45, y:25}, {x:35, y:15}, {x:25, y:20}, {x:35, y:30}] },
            cloud: { label: 'é›²ä¸Šç”Ÿæ´»', points: [{x:65, y:48}, {x:50, y:50}, {x:45, y:60}, {x:60, y:62}] },
            explore: { label: 'ç§˜å¯†æ¢ç´¢', points: [{x:68, y:65}, {x:75, y:75}, {x:85, y:70}, {x:82, y:80}] },
            social: { label: 'ç‡Ÿç«å¾®å…‰', points: [{x:40, y:65}, {x:30, y:75}, {x:35, y:85}, {x:25, y:82}] },
            social_share: { label: 'é›²ç«¯å¯„æƒ…', points: [{x:35, y:55}, {x:25, y:52}, {x:15, y:58}, {x:20, y:68}] }
        };

        const WUFENG_ELEMENTS = {
            1: { icon: 'ğŸ¦Œ', name: 'å±±ç¾Œ' }, 2: { icon: 'ğŸ—', name: 'å±±è±¬' }, 3: { icon: 'ğŸ¦¦', name: 'é»ƒçŒ´è²‚' },
            4: { icon: 'â›°ï¸', name: 'äº”å³°é€£ç¨œ' }, 5: { icon: 'ğŸŒ¸', name: 'ç·‹å¯’æ«»' }, 6: { icon: 'ğŸ', name: 'éœå–€ç¾…æ¥“ç´…' },
            7: { icon: 'â™¨ï¸', name: 'æ¸…æ³‰æº«æ³‰' }, 8: { icon: 'â˜ï¸', name: 'å±±è°·é›²æµ·' }, 9: { icon: 'ğŸŒ¾', name: 'åŸæ°‘å°ç±³' },
            10: { icon: 'ğŸ¶', name: 'å°ç±³é…’' }, 11: { icon: 'ğŸ»', name: 'å°ç£é»‘ç†Š' }, 12: { icon: 'ğŸ‹', name: 'æ¡‚ç«¹ç­' },
            13: { icon: 'ğŸ„', name: 'æ®µæœ¨é¦™è‡' }, 14: { icon: 'âœ¨', name: 'é«˜å±±æ˜Ÿç©º' }, 15: { icon: 'ğŸŒ«ï¸', name: 'å±±æ—è¿·éœ§' },
            16: { icon: 'ğŸŒ³', name: 'è‚–æ¥ å·¨æœ¨' }, 17: { icon: 'ğŸ¦‰', name: 'è²“é ­é·¹' }, 18: { icon: 'ğŸŒ¿', name: 'é¦¬å‘Š' },
            19: { icon: 'ğŸï¸', name: 'ä¸Šåªæºªæµ' }, 20: { icon: 'ğŸ¾', name: 'ç©¿å±±ç”²è¶³è·¡' }, 21: { icon: 'ğŸ¦', name: 'è—è…¹é·´' },
            22: { icon: 'ğŸ”¥', name: 'ç¥–éˆä¹‹ç«' }, 23: { icon: 'ğŸ§¶', name: 'æ³°é›…ç¹”å¸ƒ' }, 24: { icon: 'ğŸ””', name: 'è³½å¤è‡€éˆ´' },
            25: { icon: 'ğŸŒ‰', name: 'æ¸…æ³‰åŠæ©‹' }, 26: { icon: 'ğŸ’¡', name: 'å¤å¤œè¢ç«èŸ²' }, 27: { icon: 'ğŸ›–', name: 'å‚³çµ±ç«¹å±‹' },
            28: { icon: 'ğŸ‘£', name: 'å¤é“éºè·¡' }, 29: { icon: 'ğŸµ', name: 'é«˜å±±å†·èŒ¶' }, 30: { icon: 'ğŸŒ„', name: 'è§€éœ§æ—¥å‡º' }
        };

        class SoundManager {
            constructor() {
                this.bgmAudio = document.getElementById('bgm-audio');
                this.bgmAudio.volume = 0.5;
                this.isEnabled = false;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.playlist = [{ id: 'forest', name: 'æ™¨é–“æ£®æ—', icon: 'ğŸŒ²', url: 'https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3' }];
                const savedTrack = localStorage.getItem('love_hsiung_track_index');
                this.currentTrackIndex = savedTrack ? parseInt(savedTrack) : 0;
                if (this.currentTrackIndex >= this.playlist.length) this.currentTrackIndex = 0;
                this.bgmAudio.src = this.playlist[this.currentTrackIndex].url;
            }
            enable() { this.isEnabled = true; this.bgmAudio.muted = false; this.bgmAudio.play().catch(()=>{}); }
            disable() { this.isEnabled = false; this.bgmAudio.pause(); }
            toggle() { if (this.isEnabled) this.disable(); else this.enable(); return this.isEnabled; }
            setTrack(index) {
                if (index < 0 || index >= this.playlist.length) return;
                this.currentTrackIndex = index;
                localStorage.setItem('love_hsiung_track_index', index);
                this.bgmAudio.src = this.playlist[index].url;
                if (this.isEnabled) this.bgmAudio.play().catch(()=>{});
                document.dispatchEvent(new CustomEvent('trackChanged', { detail: { index: index } }));
            }
            playClick() { if (this.isEnabled && this.ctx.state !== 'suspended') { const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(800,this.ctx.currentTime);g.gain.setValueAtTime(0.05,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+0.1);o.start();o.stop(this.ctx.currentTime+0.1); } else if(this.isEnabled) this.ctx.resume(); }
            playSuccess() { if (this.isEnabled) { const now=this.ctx.currentTime;[523.25,659.25,783.99,1046.50].forEach((f,i)=>{const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);o.frequency.value=f;g.gain.setValueAtTime(0,now+i*0.08);g.gain.linearRampToValueAtTime(0.1,now+i*0.08+0.05);g.gain.exponentialRampToValueAtTime(0.001,now+i*0.08+1.2);o.start(now+i*0.08);o.stop(now+i*0.08+1.2);}); } }
            playReveal() { if (this.isEnabled) { const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);const n=this.ctx.currentTime;o.frequency.setValueAtTime(400,n);o.frequency.exponentialRampToValueAtTime(1200,n+0.6);g.gain.setValueAtTime(0.05,n);g.gain.linearRampToValueAtTime(0,n+0.6);o.start();o.stop(n+0.6); } }
        }

        class TutorialManager {
            constructor() {
                this.steps = [
                    { id: 'welcome', target: null, title: 'æ­¡è¿ä¾†åˆ°æ„›ä¸Šå–œç¿', desc: 'é€™æ˜¯ä¸€å ´å°ˆå±¬æ–¼æ‚¨çš„å±±æ—æ¢éšªã€‚æ”¶é›†ç¾å¥½å›æ†¶ï¼Œå®Œæˆé€£ç·šå³å¯å…Œæ›é©šå–œå¥½ç¦®ï¼', pos: 'center' },
                    { id: 'grid', target: 'grid-card', title: 'å›æ†¶åœ°åœ–', desc: 'é€™æ˜¯æ‚¨çš„è³“æœå¡ã€‚æ¯ä¸€å€‹æ•¸å­—éƒ½ä»£è¡¨ä¸€æ®µç¨ç‰¹çš„å›æ†¶æˆ–ä»»å‹™ã€‚', pos: 'bottom' },
                    { id: 'mission', target: 'open-missions-btn', title: 'æ¢éšªæ‰‹å†Š', desc: 'é»æ“Šæ­¤è™•æŸ¥çœ‹ä»»å‹™æ¸…å–®ã€‚å®Œæˆä»»å‹™å¯ç²å¾—éš¨æ©Ÿè™Ÿç¢¼ï¼Œé»äº®æ‚¨çš„åœ°åœ–ã€‚', pos: 'top' },
                    { id: 'music', target: 'music-menu-btn', title: 'æ£®æ—æ¨‚ç« ', desc: 'é»æ“Šæ­¤è™•å¯åˆ‡æ›èƒŒæ™¯éŸ³æ¨‚ï¼ŒåŒ…å«èŸ²é³´ã€ç‡Ÿç«ç­‰å¤§è‡ªç„¶è²éŸ³ï¼Œæå‡éœ²ç‡Ÿæ°›åœã€‚', pos: 'bottom' },
                    { id: 'scenic', target: 'toggle-scenic-btn', title: 'éœäº«å±±æ—', desc: 'æƒ³å°ˆå¿ƒæ¬£è³é¢¨æ™¯å—ï¼Ÿé»æ“Šçœ¼ç›åœ–ç¤ºå¯æš«æ™‚éš±è—æ‰€æœ‰ä»‹é¢ã€‚', pos: 'bottom' }
                ];
                this.currentStep = 0; this.isActive = false;
                this.card = document.getElementById('tutorial-card');
                this.title = document.getElementById('tut-title');
                this.desc = document.getElementById('tut-desc');
                this.dots = document.getElementById('tut-dots');
                document.getElementById('tut-next').onclick = () => this.next();
                document.getElementById('tut-skip').onclick = () => this.end();
            }
            start() { this.isActive=true; this.currentStep=0; document.body.classList.add('tutorial-active'); this.renderStep(); soundManager.playClick(); }
            end() { this.isActive=false; document.body.classList.remove('tutorial-active'); this.clearHighlight(); localStorage.setItem('love_hsiung_tutorial_seen','true'); soundManager.playClick(); }
            next() { soundManager.playClick(); if (this.currentStep < this.steps.length - 1) { this.currentStep++; this.renderStep(); } else this.end(); }
            clearHighlight() { document.querySelectorAll('.tutorial-highlight').forEach(el=>el.classList.remove('tutorial-highlight')); document.getElementById('main-action-area').style.zIndex=''; }
            renderStep() {
                this.clearHighlight(); const step = this.steps[this.currentStep];
                this.title.innerText = step.title; this.desc.innerText = step.desc;
                document.getElementById('tut-next').innerText = this.currentStep === this.steps.length - 1 ? 'é–‹å§‹æ¢éšª' : 'ä¸‹ä¸€æ­¥';
                this.card.className = `tutorial-card position-${step.pos}`;
                if (step.target) { const el = document.getElementById(step.target); if(el) { el.classList.add('tutorial-highlight'); if(step.target==='open-missions-btn') document.getElementById('main-action-area').style.zIndex='70'; el.scrollIntoView({behavior:'smooth',block:'center'}); } }
                this.dots.innerHTML = this.steps.map((_, i) => `<div class="dot-indicator ${i === this.currentStep ? 'active' : ''}"></div>`).join('');
            }
            checkFirstTime() { if (!localStorage.getItem('love_hsiung_tutorial_seen')) setTimeout(() => this.start(), 800); }
        }

        const soundManager = new SoundManager();
        const tutorialManager = new TutorialManager();

        const CATEGORIES = {
            cloud: { label: 'é›²ä¸Šç”Ÿæ´»', icon: 'â˜ï¸' }, photo: { label: 'å±±æ—å¯«çœŸ', icon: 'ğŸ“¸' },
            social_share: { label: 'é›²ç«¯å¯„æƒ…', icon: 'ğŸ’Œ' }, explore: { label: 'ç§˜å¯†æ¢ç´¢', icon: 'ğŸ—ºï¸' },
            social: { label: 'ç‡Ÿç«å¾®å…‰', icon: 'ğŸ”¥' }, soul: { label: 'éˆé­‚å°è©±', icon: 'ğŸŒ²' },
            magic: { label: 'å¥‡è¹Ÿé­”æ³•', icon: 'âœ¨' }
        };

        const MEMORY_LIST = [
            { id: 'food_dinner', category: 'cloud', title: 'ğŸ½ï¸ æ™šé¤ï¼šå…‰ç›¤è¡Œå‹• (â˜…â˜…)', type: 'staff_number', difficulty: 2, success_text: 'æ„Ÿè¬ä½ å°å¤§åœ°çš„æº«æŸ”...' },
            { id: 'food_breakfast', category: 'cloud', title: 'ğŸ¥£ æ—©é¤ï¼šæ´»åŠ›æ»¿æ»¿ (â˜…)', type: 'staff_number', difficulty: 1, success_text: 'æ™¨å…‰å–šé†’äº†å‘³è•¾...' },
            { id: 'activity_archery', category: 'cloud', title: 'ğŸ¹ çµäººå°„ç®­é«”é©— (â˜…â˜…â˜…)', type: 'staff_number', difficulty: 3, success_text: 'å¦‚é·¹ä¸€èˆ¬çš„å°ˆæ³¨çœ¼ç¥...' },
            { id: 'gold_boss', category: 'cloud', title: 'ğŸŒŸ é»ƒé‡‘ä»»å‹™ï¼šç‡Ÿä¸»å¤§æŒ‘æˆ° (â˜…â˜…â˜…)', type: 'user_choice', difficulty: 3, success_text: 'ä½ è§¸å‹•äº†å±±ç¥çš„å¥‡è¹Ÿ...' },
            { id: 'life_chill', category: 'cloud', title: 'ğŸ¹ åœ¨å¤©å¹•ä¸‹å–æ¯èŒ¶ (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'èŒ¶é¦™èˆ‡é¢¨å…±èˆ...' },
            { id: 'view_cloud', category: 'photo', title: 'ğŸ“¸ é›²æµ·è§€æ™¯å°åˆç…§ (â˜…â˜…)', type: 'code_draw', difficulty: 2, success_text: 'ä½ æ”¶è—äº†é›²æµ·çš„å‘¼å¸...' },
            { id: 'photo_flower', category: 'photo', title: 'ğŸŒ¸ æ‹ä¸‹ç‡Ÿå€æœ€ç¾çš„èŠ± (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'èŠ±æœµå› ä½ çš„æ³¨è¦–è€Œç¶»æ”¾...' },
            { id: 'photo_smile', category: 'photo', title: 'ğŸ˜Š æ‹ä¸€å¼µæœ€ç‡¦çˆ›çš„ç¬‘å®¹ (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'ç¬‘å®¹æ˜¯ä¸–ç•Œä¸Šæœ€ç¾çš„é¢¨æ™¯...' },
            { id: 'photo_group', category: 'photo', title: 'ğŸ‘¥ é‚€è«‹è·¯äººå¹«æ‹åˆç…§ (â˜…â˜…)', type: 'code_draw', difficulty: 2, success_text: 'å®šæ ¼äº†ç›¸èšçš„ç·£åˆ†...' },
            { id: 'share_story', category: 'social_share', title: 'ğŸ“± å¯„å‡ºä¸€å¼µé›²ç«¯æ˜ä¿¡ç‰‡ (IG/FBé™å‹•) (â˜…)', type: 'user_choice', difficulty: 1, success_text: 'è¨Šè™Ÿç©¿è¶Šäº†é›²å±¤...' },
            { id: 'share_checkin', category: 'social_share', title: 'ğŸ“ åœ¨é›²ç«¯åœ°åœ–ç•™ä¸‹è¶³è·¡ (æ‰“å¡) (â˜…)', type: 'user_choice', difficulty: 1, success_text: 'è¶³è·¡åˆ»ç•«åœ¨æ•¸ä½åœ°åœ–...' },
            { id: 'share_review', category: 'social_share', title: 'ğŸŒŸ é»äº®å¤œç©ºä¸­çš„ç¬¬äº”é¡†æ˜Ÿ (Googleå¥½è©•) (â˜…â˜…â˜…)', type: 'user_choice', difficulty: 3, success_text: 'ä½ çš„æ–‡å­—æ˜¯æœ€å¥½çš„æ¨è–¦...' },
            { id: 'share_tag', category: 'social_share', title: 'ğŸ·ï¸ å¯„é€ä¸€ä»½é›²ç«¯é‚€ç´„ (æ¨™è¨˜å¥½å‹) (â˜…â˜…)', type: 'user_choice', difficulty: 2, success_text: 'éºæ†¾æ˜¯ç‚ºäº†ä¸‹æ¬¡çš„ç›¸é‡...' },
            { id: 'share_line', category: 'social_share', title: 'ğŸ’¬ å‚³é€ä¾†è‡ªé«˜å±±çš„å•å€™ (å‚³ç…§ç‰‡çµ¦å®¶äºº) (â˜…)', type: 'user_choice', difficulty: 1, success_text: 'é æ–¹çš„ç‰½æ›æ”¶åˆ°äº†å¹³å®‰...' },
            { id: 'explore_star', category: 'explore', title: 'ğŸŒŒ æ‰¾åˆ°å¤œç©ºä¸­æœ€äº®é‚£é¡†æ˜Ÿ (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'æ˜Ÿå…‰ç©¿è¶Šå…‰å¹´è€Œä¾†...' },
            { id: 'explore_bird', category: 'explore', title: 'ğŸ¦ éŒ„ä¸‹ä¸€æ®µé³¥å«è² (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'æ£®æ—æ­Œæ‰‹ç‚ºä½ ç»å”±...' },
            { id: 'explore_barefoot', category: 'explore', title: 'ğŸ¦¶ èµ¤è…³è¸©åœ¨è‰åœ°ä¸Š (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'å¤§åœ°é›»æµç©¿é€è…³å¿ƒ...' },
            { id: 'explore_tree', category: 'explore', title: 'ğŸŒ³ æ“æŠ±ä¸€æ£µå¤§æ¨¹ 10 ç§’ (â˜…â˜…â˜…)', type: 'code_draw', difficulty: 3, success_text: 'è€æ¨¹å‚³éäº†ç™¾å¹´çš„æ™ºæ…§...' },
            { id: 'explore_insect', category: 'explore', title: 'ğŸ è§€å¯Ÿä¸€éš»å°æ˜†èŸ² (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'å¾®å°çš„ç”Ÿå‘½ä¹Ÿæœ‰å¤§å¤§çš„ä¸–ç•Œ...' },
            { id: 'social_hi', category: 'social', title: 'ğŸ‘‹ è·Ÿéš”å£å¸³ç¯·æ‰“æ‹›å‘¼ (â˜…)', type: 'user_choice', difficulty: 1, success_text: 'å¾®ç¬‘æ˜¯æœ€å¥½çš„èªè¨€...' },
            { id: 'social_staff', category: 'social', title: 'â¤ï¸ è·Ÿå·¥ä½œäººå“¡èªªè²è¾›è‹¦äº† (â˜…â˜…)', type: 'staff_number', difficulty: 2, success_text: 'ä½ çš„é«”è²¼æº«æš–äº†äººå¿ƒ...' },
            { id: 'social_snack', category: 'social', title: 'ğŸª åˆ†äº«é›¶é£Ÿçµ¦æ–°æœ‹å‹ (â˜…â˜…)', type: 'user_choice', difficulty: 2, success_text: 'åˆ†äº«è®“å¿«æ¨‚åŠ å€...' },
            { id: 'social_highfive', category: 'social', title: 'âœ‹ è·Ÿç®¡å®¶æ“ŠæŒ High Five (â˜…)', type: 'staff_number', difficulty: 1, success_text: 'æ¸…è„†çš„æŒè²éŸ¿å¾¹å±±æ—...' },
            { id: 'social_cheers', category: 'social', title: 'ğŸ» èˆ‰æ¯æ…¶ç¥é€™ä¸€åˆ» (â˜…)', type: 'user_choice', difficulty: 1, success_text: 'ä¹¾æ¯çš„è²éŸ³æ˜¯å¿«æ¨‚çš„æ¨‚ç« ...' },
            { id: 'deep_shout', category: 'soul', title: 'ğŸŒ² å°è‘—å¤§å±±å–Šå‡ºç…©æƒ± (â˜…â˜…)', type: 'code_draw', difficulty: 2, success_text: 'å±±è°·æ¥ç´äº†ä½ çš„ç§˜å¯†...' },
            { id: 'deep_letter', category: 'soul', title: 'âœï¸ å¯«çµ¦æ˜å¹´è‡ªå·±çš„ä¸€å¥è©± (â˜…â˜…â˜…)', type: 'user_choice', difficulty: 3, success_text: 'æ™‚å…‰è† å›Šå·²å°å­˜...' },
            { id: 'deep_meditate', category: 'soul', title: 'ğŸ§˜ åœ¨æ¨¹ä¸‹é–‰çœ¼ç™¼å‘† (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'åœ¨å¯§éœä¸­æ‰¾å›äº†é »ç‡...' },
            { id: 'deep_secret', category: 'soul', title: 'ğŸ¤« è·Ÿæ—…ä¼´åˆ†äº«ä¸€å€‹ç§˜å¯† (â˜…â˜…â˜…)', type: 'user_choice', difficulty: 3, success_text: 'ä¿¡ä»»æ˜¯éˆé­‚çš„æ“æŠ±...' },
            { id: 'deep_thank', category: 'soul', title: 'ğŸ™ åœ¨å¿ƒè£¡æ„Ÿè¬ä¸€å€‹äºº (â˜…)', type: 'code_draw', difficulty: 1, success_text: 'æ„Ÿæ©çš„å¿ƒæœƒç™¼å…‰...' },
            { id: 'magic_potion', category: 'magic', title: 'ğŸ· å“åšä¸€ç“¶é­”æ³•è—¥æ°´ (è³¼è²·ç´…/ç™½é…’) (â˜…â˜…â˜…â˜…)', type: 'staff_number', difficulty: 4, success_text: 'å¾®é†ºæ˜¯é€šå¾€é­”æ³•ä¸–ç•Œçš„é‘°åŒ™...' },
            { id: 'magic_alchemy', category: 'magic', title: 'ğŸ’ ç™¼å‹•å±±æ—ç…‰é‡‘è¡“ (ç‡Ÿæœ¬éƒ¨æ¶ˆè²»æ»¿500) (â˜…â˜…â˜…â˜…)', type: 'staff_number', difficulty: 4, success_text: 'èƒ½é‡äº¤æ›ç”¢ç”Ÿäº†å¥‡è¹Ÿ...' },
            { id: 'magic_bard', category: 'magic', title: 'ğŸ¤ åŸå”±å¤è€çš„æ­Œè¬  (åœ¨æ«ƒæª¯é«˜æ­Œä¸€æ›²) (â˜…â˜…â˜…â˜…)', type: 'staff_number', difficulty: 4, success_text: 'æ­Œè²å–šé†’äº†æ²‰ç¡çš„ç²¾éˆ...' },
            { id: 'magic_dance', category: 'magic', title: 'ğŸ’ƒ ç»ä¸Šä¸€æ”¯ç²¾éˆä¹‹èˆ (è·³èˆçµ¦ç®¡å®¶çœ‹) (â˜…â˜…â˜…)', type: 'staff_number', difficulty: 3, success_text: 'èˆå§¿æ“¾å‹•äº†é¢¨çš„æµå‘...' },
            { id: 'magic_spell', category: 'magic', title: 'ğŸ’– å”¸å‡ºæ„›çš„å¬å–šå’’ (å¤§å–Šè€é—†æˆ‘æ„›ä½ ) (â˜…â˜…â˜…)', type: 'staff_number', difficulty: 3, success_text: 'å¼·å¤§çš„å’’èªéœ‡å‹•äº†å±±è°·...' }
        ];

        const CONFIG = { gridSize: 25, numberRange: 30, storageKey: 'love_hsiung_bingo_v11_final' };
        const BINGO_PATTERNS = [ [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [0,6,12,18,24], [4,8,12,16,20] ];

        let state = { grid: [], markedIndices: [], completedMissions: [], isSelectionMode: false, claimedLines: 0, currentFilter: 'all', currentView: 'list', completedLinePatterns: [] };
        let currentMission = null;

        const els = {
            grid: document.getElementById('grid-container'),
            progress: document.getElementById('progress-text'),
            totalLines: document.getElementById('total-lines'),
            modalMissions: document.getElementById('mission-modal'),
            missionContent: document.getElementById('mission-content'),
            missionList: document.getElementById('mission-grid'),
            categoryFilter: document.getElementById('category-filter-container'),
            modalInput: document.getElementById('input-modal'),
            modalResult: document.getElementById('result-modal'),
            modalSetup: document.getElementById('setup-modal'),
            modalManual: document.getElementById('manual-setup-modal'),
            manualGrid: document.getElementById('manual-input-grid'),
            manualConfirm: document.getElementById('btn-manual-confirm'),
            manualValidation: document.getElementById('manual-validation-msg'),
            inputIcon: document.getElementById('input-icon'),
            inputTitle: document.getElementById('input-title'),
            inputHint: document.getElementById('input-hint'),
            staffPinField: document.getElementById('staff-pin-input'),
            staffPinContainer: document.getElementById('staff-pin-container'),
            toggleScenic: document.getElementById('toggle-scenic-btn'),
            toggleSound: document.getElementById('toggle-sound-btn'),
            btnHelp: document.getElementById('help-btn'),
            exitScenic: document.getElementById('exit-scenic-btn'),
            splashScreen: document.getElementById('splash-screen'),
            splashStartBtn: document.getElementById('splash-start-btn'),
            musicMenuBtn: document.getElementById('music-menu-btn'),
            modalMusic: document.getElementById('music-modal'),
            closeMusicBtn: document.getElementById('close-music-btn'),
            trackList: document.getElementById('track-list'),
            enterBonfireBtn: document.getElementById('enter-bonfire-btn'),
            modalBonfire: document.getElementById('bonfire-modal'),
            tossPineconeBtn: document.getElementById('toss-pinecone-btn'),
            closeBonfireBtn: document.getElementById('close-bonfire-btn'),
            bonfireWrapper: document.getElementById('bonfire-wrapper'),
            projectile: document.getElementById('pinecone-projectile'),
            bonfireResultMsg: document.getElementById('bonfire-result-msg'),
            toast: document.getElementById('bingo-toast'),
            tabMissions: document.getElementById('tab-missions'),
            tabGuide: document.getElementById('tab-guide'),
            viewTaskList: document.getElementById('view-task-list'),
            viewStarMap: document.getElementById('view-star-map'),
            pegasusTooltip: document.getElementById('pegasus-tooltip'),
            svgMapWrapper: document.getElementById('svg-map-wrapper'),
            certificateView: document.getElementById('certificate-view')
        };

        function saveState() { localStorage.setItem(CONFIG.storageKey, JSON.stringify(state)); }
        function loadState() {
            const saved = localStorage.getItem(CONFIG.storageKey);
            if (saved) {
                state = JSON.parse(saved);
                if (!state.completedLinePatterns) state.completedLinePatterns = [];
                if (!state.currentView) state.currentView = 'list';
                renderGrid(); updateStats();
            }
        }

        function generateStarParticles(container) {
            const starCount = 20 + Math.floor(Math.random() * 15);
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('particle-star');
                const size = 1 + Math.random() * 2.5;
                const left = Math.random() * 100; const top = Math.random() * 80;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.left = `${left}%`; star.style.top = `${top}%`;
                star.style.animationDuration = `${1.5 + Math.random() * 2.5}s`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(star);
            }
        }

        function renderGrid() {
            els.grid.innerHTML = '';
            const glowIndices = new Set();
            state.completedLinePatterns.forEach(idx => BINGO_PATTERNS[idx].forEach(cellIdx => glowIndices.add(cellIdx)));

            state.grid.forEach((num, index) => {
                const isMarked = state.markedIndices.includes(index);
                const isGlow = glowIndices.has(index);
                const div = document.createElement('div');
                div.className = `memory-frame flex flex-col items-center justify-center relative select-none ${isMarked ? 'collected' : ''} ${isGlow ? 'bingo-line-glow' : ''}`;
                div.innerHTML = `<div class="cell-content flex items-center justify-center w-full h-full z-10"><span class="bingo-number text-4xl font-bold font-serif transition-all duration-300">${num}</span></div>`;
                if (isMarked) {
                    const starLayer = document.createElement('div');
                    starLayer.style.position = 'absolute'; starLayer.style.inset = '0'; starLayer.style.zIndex = '1'; starLayer.style.pointerEvents = 'none';
                    generateStarParticles(starLayer); div.appendChild(starLayer);
                }
                if (!isMarked && state.isSelectionMode) div.onclick = () => handleUserSelection(index);
                els.grid.appendChild(div);
            });
            document.getElementById('selection-banner').classList.toggle('hidden', !state.isSelectionMode);
        }

        function checkBingoLines() {
            let newLinesFound = false;
            BINGO_PATTERNS.forEach((pattern, idx) => {
                if (!state.completedLinePatterns.includes(idx)) {
                    if (pattern.every(cellIdx => state.markedIndices.includes(cellIdx))) {
                        state.completedLinePatterns.push(idx); newLinesFound = true;
                    }
                }
            });
            if (newLinesFound) { fireConfetti(); showBingoToast(); renderGrid(); saveState(); updateStats(); }
        }

        function fireConfetti() { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#FFD700', '#FFFFFF', '#1E3A8A'], zIndex: 9999 }); soundManager.playSuccess(); }
        function showBingoToast() { els.toast.classList.add('active'); setTimeout(() => els.toast.classList.remove('active'), 3000); }
        function updateStats() {
            els.progress.innerText = state.markedIndices.length;
            els.totalLines.innerText = state.completedLinePatterns.length;
            const pinecones = Math.max(0, state.completedLinePatterns.length - (state.claimedLines || 0));
            document.getElementById('pinecones-available').innerText = pinecones;
            document.getElementById('enter-bonfire-btn').classList.toggle('hidden', pinecones <= 0);
        }

        function switchView(viewName) {
            state.currentView = viewName;
            const isMap = viewName === 'map';
            els.tabMissions.classList.toggle('active', !isMap);
            els.tabGuide.classList.toggle('active', isMap);
            els.viewTaskList.classList.toggle('hidden', isMap);
            els.viewStarMap.classList.toggle('hidden', !isMap);
            els.missionContent.classList.toggle('map-mode', isMap);
            
            const titleEl = document.querySelector('.mission-modal-title');
            const subTitleEl = document.querySelector('.mission-modal-subtitle');
            
            if(isMap) {
                titleEl.innerText = "å¤©é¦¬æ˜Ÿåœ–";
                subTitleEl.innerText = "PEGASUS CONSTELLATION";
                if (els.svgMapWrapper.classList.contains('hidden')) { 
                    // If certificate is shown, do nothing or handle re-render if needed
                } else {
                    renderPegasusMap(); 
                }
            } else {
                titleEl.innerText = "æˆ‘çš„å±±æ—æ‹¾å…‰";
                subTitleEl.innerText = "Love Hsiung Collection";
                renderMissionGrid();
            }
        }

        els.tabMissions.onclick = () => switchView('list');
        els.tabGuide.onclick = () => switchView('map');

        function renderMissionGrid() {
            els.missionList.innerHTML = '';
            els.categoryFilter.querySelectorAll('.category-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.category == state.currentFilter));
            const filtered = state.currentFilter === 'all' ? MEMORY_LIST : MEMORY_LIST.filter(m => m.category == state.currentFilter);
            if (filtered.length === 0) { els.missionList.innerHTML = `<div class="col-span-2 flex flex-col items-center justify-center py-12 text-slate-400"><p class="text-sm font-medium italic">æ­¤å€åŸŸç›®å‰ç„¡å¯é€²è¡Œçš„ä»»å‹™</p></div>`; return; }
            filtered.forEach(m => {
                const isDone = state.completedMissions.includes(m.id);
                const stars = 'â˜…'.repeat(m.difficulty);
                const cat = CATEGORIES[m.category];
                const card = document.createElement('div');
                card.className = `p-3 rounded-xl border flex flex-col justify-between h-32 relative overflow-hidden transition-all ${isDone ? 'bg-slate-800/50 border-slate-700 opacity-60 grayscale' : 'bg-slate-800/80 border-slate-600/50 hover:bg-slate-700 active:scale-95'}`;
                card.dataset.missionId = m.id;
                card.innerHTML = `<div class="flex justify-between items-start mb-1"><span class="text-xl">${cat.icon}</span><span class="text-[#D4AF37] text-[10px] tracking-tight">${stars}</span></div><h4 class="text-gray-100 font-bold text-xs leading-snug line-clamp-2 mb-2">${m.title.replace(/^[^ ]+ /, '')}</h4><div class="mt-auto"><span class="block w-full text-center py-1.5 rounded-lg text-[10px] font-bold tracking-widest ${isDone ? 'bg-emerald-900/30 text-emerald-400 border border-emerald-800' : 'bg-[#D4AF37] text-[#1a202c] shadow-lg'}">${isDone ? 'âœ“ å®Œæˆ' : 'é©—è­‰'}</span></div>`;
                if (!isDone) card.onclick = (e) => { e.stopPropagation(); soundManager.playClick(); openInputModal(m); };
                els.missionList.appendChild(card);
            });
        }

        function getCategoryCompletion(categoryKey) {
             const missions = MEMORY_LIST.filter(m => m.category === categoryKey);
             const total = missions.length;
             const completed = missions.filter(m => state.completedMissions.includes(m.id)).length;
             return { total, completed, isFull: total > 0 && completed === total };
        }

        function renderPegasusMap() {
            const bgStars = document.getElementById('bg-stars');
            const phantomGroup = document.getElementById('phantom-lines');
            const pegasusBody = document.getElementById('pegasus-body');
            bgStars.innerHTML = ''; phantomGroup.innerHTML = ''; pegasusBody.innerHTML = '';
            
            for(let i=0; i<40; i++) {
                const c = document.createElementNS(svgNS, "circle");
                c.setAttribute("cx", Math.random()*400); c.setAttribute("cy", Math.random()*400); c.setAttribute("r", Math.random()*1.5);
                c.setAttribute("fill", "#FFF"); c.setAttribute("opacity", Math.random()*0.6);
                bgStars.appendChild(c);
            }

            let allCategoriesComplete = true;
            const SCALE = 4;

            Object.keys(PEGASUS_MAP).forEach(key => {
                const part = PEGASUS_MAP[key];
                const points = part.points;
                const { total, completed, isFull } = getCategoryCompletion(key);
                if (!isFull) allCategoriesComplete = false;

                if (points.length > 1) {
                    let d = `M ${points[0].x * SCALE} ${points[0].y * SCALE}`;
                    for(let i=1; i<points.length; i++) d += ` L ${points[i].x * SCALE} ${points[i].y * SCALE}`;
                    const path = document.createElementNS(svgNS, "path");
                    path.setAttribute("d", d); path.setAttribute("class", "phantom-line");
                    phantomGroup.appendChild(path);
                }

                const partGroup = document.createElementNS(svgNS, "g");
                partGroup.setAttribute("id", `pegasus-${key}`);
                
                if (isFull && points.length >= 3) {
                     const pointString = points.map(p => `${p.x * SCALE},${p.y * SCALE}`).join(" ");
                     const poly = document.createElementNS(svgNS, "polygon");
                     poly.setAttribute("points", pointString); poly.setAttribute("class", "energy-shape");
                     partGroup.appendChild(poly);
                }

                if (isFull && points.length > 1) {
                     let d = `M ${points[0].x * SCALE} ${points[0].y * SCALE}`;
                     for(let i=1; i<points.length; i++) d += ` L ${points[i].x * SCALE} ${points[i].y * SCALE}`;
                     const activePath = document.createElementNS(svgNS, "path");
                     activePath.setAttribute("d", d); activePath.setAttribute("class", "active-line");
                     partGroup.appendChild(activePath);
                     if (key === 'magic') partGroup.setAttribute("class", "animate-wings");
                     if (key === 'explore' || key === 'social') partGroup.setAttribute("class", "animate-legs");
                }

                const ratio = total > 0 ? (completed / total) : 0;
                const starsToShowCount = isFull ? points.length : Math.ceil(ratio * points.length);

                points.forEach((pt, idx) => {
                     const isUnlocked = idx < starsToShowCount;
                     if (isUnlocked) {
                         const circle = document.createElementNS(svgNS, "circle");
                         circle.setAttribute("cx", pt.x * SCALE); circle.setAttribute("cy", pt.y * SCALE);
                         circle.setAttribute("r", isFull ? 5 : 3.5);
                         circle.setAttribute("class", "star-point star-unlocked");
                         if (!isFull) circle.style.fill = "#FFF";
                         circle.addEventListener('mouseenter', () => showPegasusTooltip(part.label, pt.x * SCALE, pt.y * SCALE, isFull));
                         circle.addEventListener('mouseleave', () => els.pegasusTooltip.classList.remove('visible'));
                         circle.addEventListener('click', (e) => { e.stopPropagation(); showPegasusTooltip(part.label, pt.x * SCALE, pt.y * SCALE, isFull); });
                         partGroup.appendChild(circle);
                     }
                });
                pegasusBody.appendChild(partGroup);
            });

            if (allCategoriesComplete) {
                if (!pegasusBody.classList.contains('pegasus-finale-anim')) {
                     setTimeout(() => {
                         pegasusBody.classList.add('pegasus-finale-anim');
                         setTimeout(() => { showCertificateView(); }, 3800);
                     }, 500);
                }
            }
        }
        
        function showCertificateView() {
            els.svgMapWrapper.classList.add('hidden');
            els.certificateView.classList.remove('hidden');
            
            const certificateHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-8 animate-fade-in bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2070&auto=format&fit=crop');">
                    <div class="bg-slate-900/90 backdrop-blur-xl p-8 rounded-3xl border-2 border-[#D4AF37] shadow-[0_0_50px_rgba(212,175,55,0.3)] max-w-md mx-auto">
                        <div class="text-5xl mb-4">âœ¨</div>
                        <h2 class="text-3xl font-bold text-[#D4AF37] mb-2 font-serif tracking-widest">å¤©é¦¬é¨å£«è­‰æ›¸</h2>
                        <p class="text-gray-300 text-sm mb-6 uppercase tracking-widest">2026 Love Hsiung Glamping</p>
                        
                        <img src="https://cdn.pixabay.com/photo/2018/03/30/17/31/pegasus-3275998_1280.png" 
                             alt="Golden Pegasus" 
                             class="w-64 h-auto mx-auto mb-6 filter drop-shadow-[0_0_30px_rgba(255,215,0,0.6)] hover:scale-105 transition-transform duration-700">
                        
                        <p class="text-indigo-200 italic mb-8 text-sm leading-relaxed">
                            "ä½ ç”¨æ˜Ÿå…‰é»äº®äº†æ•´ç‰‡å±±æ—ï¼Œ<br>é¡˜é€™ä»½å¥‡è¹Ÿæ°¸é ä¼´éš¨ä½ çš„æ—…ç¨‹ã€‚"
                        </p>
                        <button onclick="alert('ğŸ“¸ è«‹æˆªåœ–ä¿å­˜æ‚¨çš„å‚³èªªè­‰æ›¸ï¼')" class="bg-gradient-to-r from-[#BF953F] to-[#FBF5B7] text-slate-900 font-bold px-8 py-3 rounded-full shadow-lg hover:shadow-[0_0_20px_gold] transition-all transform hover:-translate-y-1">
                            ğŸ“¸ ä¸‹è¼‰å‚³èªª
                        </button>
                    </div>
                </div>
            `;
            
            els.certificateView.innerHTML = certificateHTML;
            fireConfetti();
        }
        
        function showPegasusTooltip(label, cx, cy, isComplete) {
            const container = els.viewStarMap;
            const rect = container.getBoundingClientRect();
            const scaleX = rect.width / 400; const scaleY = rect.height / 400;
            const screenX = cx * scaleX; const screenY = cy * scaleY;
            
            els.pegasusTooltip.innerHTML = `<strong style="color:${isComplete ? '#FCD34D' : '#FFF'}">${label}</strong><br/><span class="text-[10px] text-gray-400">${isComplete ? 'âœ¨ æ˜Ÿåº§å·²é»äº®' : 'ğŸ”’ æ”¶é›†é€²åº¦ä¸­'}</span>`;
            els.pegasusTooltip.style.left = `${screenX}px`; els.pegasusTooltip.style.top = `${screenY - 45}px`;
            els.pegasusTooltip.style.transform = `translateX(-50%)`; els.pegasusTooltip.classList.add('visible');
        }

        function openModal(modal) {
            modal.classList.remove('hidden');
            const content = modal.querySelector('.modal-enter');
            setTimeout(() => { modal.classList.remove('opacity-0'); if (content) content.classList.add('modal-enter-active'); }, 10);
            if(modal === els.modalMissions) switchView('list');
        }

        function closeModal(modal) {
            const content = modal.querySelector('.modal-enter');
            modal.classList.add('opacity-0'); if (content) content.classList.remove('modal-enter-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        function renderTrackList() {
            els.trackList.innerHTML = '';
            soundManager.playlist.forEach((track, index) => {
                const isActive = index === soundManager.currentTrackIndex;
                const btn = document.createElement('button');
                btn.className = `track-item w-full flex items-center gap-4 p-3 rounded-xl border border-transparent transition-all hover:bg-gray-50 ${isActive ? 'active' : ''}`;
                btn.innerHTML = `<div class="track-icon w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-lg transition-transform">${track.icon}</div><div class="flex-1 text-left"><div class="text-[#2C3E50] font-medium text-sm tracking-wide">${track.name}</div>${isActive ? '<div class="text-[10px] text-[#D4AF37] font-bold mt-0.5 animate-pulse">æ­£åœ¨æ’­æ”¾</div>' : ''}</div>`;
                btn.onclick = () => { soundManager.setTrack(index); soundManager.playClick(); };
                els.trackList.appendChild(btn);
            });
        }
        document.addEventListener('trackChanged', renderTrackList);
        els.musicMenuBtn.onclick = () => { soundManager.playClick(); renderTrackList(); openModal(els.modalMusic); }
        els.closeMusicBtn.onclick = () => closeModal(els.modalMusic);

        function openInputModal(m) {
            currentMission = m;
            els.inputIcon.innerText = 'ğŸŒŸ'; els.inputTitle.innerText = m.title;
            els.inputHint.innerText = 'å®Œæˆä»»å‹™å¾Œï¼Œè«‹å·¥ä½œäººå“¡è¼¸å…¥é€šè¡Œç¢¼ï¼Œæˆ–è‡ªè¡Œé©—è­‰ã€‚';
            els.staffPinField.value = ''; els.staffPinContainer.classList.toggle('hidden', m.type !== 'staff_number');
            openModal(els.modalInput);
        }

        els.enterBonfireBtn.onclick = () => { soundManager.playClick(); if (Math.max(0, state.completedLinePatterns.length - (state.claimedLines || 0)) > 0) openModal(els.modalBonfire); };
        els.closeBonfireBtn.onclick = () => { closeModal(els.modalBonfire); els.bonfireWrapper.classList.remove('bonfire-flare'); els.projectile.classList.remove('animate-toss'); els.bonfireResultMsg.style.opacity = '0'; };

        let isTossing = false;
        els.tossPineconeBtn.onclick = () => {
            if(isTossing) return;
            const pinecones = Math.max(0, state.completedLinePatterns.length - (state.claimedLines || 0));
            if (pinecones <= 0) return;
            isTossing = true; els.tossPineconeBtn.disabled = true; els.tossPineconeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            soundManager.playClick(); els.projectile.classList.add('animate-toss');
            setTimeout(() => { els.bonfireWrapper.classList.add('bonfire-flare'); soundManager.playReveal(); }, 600);
            const prizes = ['ç¥ç§˜å°ç¦®ç‰©', 'é£²å“å…Œæ›åˆ¸', 'ç‡Ÿç«æ£‰èŠ±ç³–', 'æ‹ç«‹å¾—ä¸€å¼µ', 'æ™šé¤åŠ èœ', 'ä¸‹æ¬¡ä½å®¿9æŠ˜'];
            const prize = prizes[Math.floor(Math.random() * prizes.length)];

            setTimeout(() => {
                state.claimedLines = (state.claimedLines || 0) + 1;
                saveState(); updateStats();
                els.bonfireResultMsg.innerText = `ğŸ ç²å¾—ï¼š${prize}`; els.bonfireResultMsg.style.opacity = '1'; fireConfetti();
                isTossing = false; els.tossPineconeBtn.disabled = false; els.tossPineconeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                setTimeout(() => { els.projectile.classList.remove('animate-toss'); els.bonfireWrapper.classList.remove('bonfire-flare'); }, 1000);
            }, 1200);
        };

        els.splashStartBtn.onclick = () => { soundManager.enable(); els.splashScreen.style.opacity = '0'; setTimeout(() => { els.splashScreen.remove(); const saved = localStorage.getItem(CONFIG.storageKey); if (!saved) openModal(els.modalSetup); else tutorialManager.checkFirstTime(); }, 800); };
        document.getElementById('btn-setup-random').onclick = () => { state.grid = Array.from({length: CONFIG.numberRange}, (_, i) => i + 1).sort(() => Math.random() - 0.5).slice(0, 25); completeSetup(); };
        document.getElementById('btn-setup-manual').onclick = () => { closeModal(els.modalSetup); initManualGrid(); openModal(els.modalManual); };

        function completeSetup() { state.markedIndices = []; state.completedMissions = []; state.claimedLines = 0; state.completedLinePatterns = []; saveState(); renderGrid(); updateStats(); closeModal(els.modalSetup); closeModal(els.modalManual); soundManager.playSuccess(); tutorialManager.checkFirstTime(); }

        function initManualGrid() {
            els.manualGrid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const input = document.createElement('input'); input.type = 'number'; input.inputMode = 'numeric'; input.className = 'manual-input-cell'; input.placeholder = '-'; input.dataset.index = i; input.oninput = (e) => handleManualInput(e.target); els.manualGrid.appendChild(input);
            }
            validateManualGrid();
        }

        function handleManualInput(input) { if (input.value.length > 2) input.value = input.value.slice(0, 2); validateManualGrid(); }
        function validateManualGrid() {
            const inputs = Array.from(els.manualGrid.querySelectorAll('input')); const values = inputs.map(i => i.value ? parseInt(i.value) : null);
            let duplicates = []; let outOfRange = false;
            values.forEach((v, idx) => { inputs[idx].classList.remove('duplicate'); if (v !== null) { if (v < 1 || v > CONFIG.numberRange) outOfRange = true; if (values.filter(x => x === v).length > 1) { duplicates.push(v); inputs[idx].classList.add('duplicate'); } } });
            const uniqueValues = new Set(values.filter(v => v !== null));
            els.manualConfirm.disabled = uniqueValues.size !== 25 || outOfRange;
            if (duplicates.length > 0) els.manualValidation.innerText = 'æ•¸å­—ä¸èƒ½é‡è¤‡ï¼'; else if (outOfRange) els.manualValidation.innerText = `æ•¸å­—å¿…é ˆåœ¨ 1-${CONFIG.numberRange} ä¹‹é–“`; else els.manualValidation.innerText = '';
        }

        document.getElementById('btn-manual-autofill').onclick = () => {
            const inputs = Array.from(els.manualGrid.querySelectorAll('input')); const currentValues = new Set(inputs.map(i => i.value ? parseInt(i.value) : null).filter(v => v !== null));
            const available = Array.from({length: CONFIG.numberRange}, (_, i) => i + 1).filter(v => !currentValues.has(v)); available.sort(() => Math.random() - 0.5);
            inputs.forEach(input => { if (!input.value || input.classList.contains('duplicate')) if (available.length > 0) input.value = available.pop(); });
            validateManualGrid();
        };

        document.getElementById('btn-manual-clear').onclick = () => { els.manualGrid.querySelectorAll('input').forEach(i => i.value = ''); validateManualGrid(); };
        els.manualConfirm.onclick = () => { state.grid = Array.from(els.manualGrid.querySelectorAll('input')).map(i => parseInt(i.value)); completeSetup(); };
        els.toggleScenic.onclick = () => document.body.classList.add('scenic-mode');
        els.exitScenic.onclick = () => document.body.classList.remove('scenic-mode');
        els.toggleSound.onclick = () => { const isEnabled = soundManager.toggle(); document.getElementById('icon-sound-off').classList.toggle('hidden', isEnabled); document.getElementById('icon-sound-on').classList.toggle('hidden', !isEnabled); };
        els.btnHelp.onclick = () => tutorialManager.start();
        document.getElementById('open-missions-btn').onclick = () => { openModal(els.modalMissions); };
        els.categoryFilter.onclick = (e) => { const btn = e.target.closest('.category-btn'); if (btn) { state.currentFilter = btn.dataset.category; renderMissionGrid(); } };
        document.getElementById('close-mission-btn').onclick = () => closeModal(els.modalMissions);
        document.getElementById('cancel-input-btn').onclick = () => closeModal(els.modalInput);

        document.getElementById('submit-input-btn').onclick = () => {
            if (currentMission.type === 'staff_number' && els.staffPinField.value !== SECURITY.STAFF_PIN) { alert("é€šè¡Œç¢¼éŒ¯èª¤ï¼"); return; }
            const count = currentMission.difficulty || 1;
            const drawnNumbers = []; const pool = Array.from({length: CONFIG.numberRange}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            for (let i = 0; i < count; i++) drawnNumbers.push(pool[i]);
            closeModal(els.modalInput);
            const card = document.querySelector(`[data-mission-id="${currentMission.id}"]`); if (card) card.classList.add('mission-complete-anim');
            setTimeout(() => { closeModal(els.modalMissions); showResultModal(drawnNumbers); }, 500);
        };

        function showResultModal(numbers) {
            const resultCard = document.getElementById('result-card'); const resultText = document.getElementById('result-context-text');
            const resultNumber = document.getElementById('result-number-display'); const resultActions = document.getElementById('result-actions');
            const burstRays = document.getElementById('burst-rays'); const closeBtn = document.getElementById('close-result-btn');

            resultCard.classList.remove('card-enter-anim', 'animate-float'); resultNumber.classList.remove('stamp-reveal');
            burstRays.style.opacity = '0'; resultCard.style.opacity = '0'; resultCard.style.transform = 'scale(0.8)';
            resultText.style.opacity = '0'; resultNumber.style.opacity = '0'; resultActions.style.opacity = '0'; closeBtn.style.pointerEvents = 'none';

            resultText.innerText = currentMission.success_text || "ä¸€æ®µç¾å¥½çš„å±±æ—è¨˜æ†¶ï¼Œå·²æ‚„æ‚„æ”¶è—...";
            if (numbers.length > 1) { resultNumber.style.fontSize = numbers.length >= 4 ? '2rem' : '3.5rem'; resultNumber.innerText = numbers.map(n => `NO.${n}`).join("\n"); }
            else { resultNumber.style.fontSize = '2.5rem'; const element = WUFENG_ELEMENTS[numbers[0]] || { name: 'æœªçŸ¥', icon: 'â“' }; resultNumber.innerHTML = `<div class="text-4xl mb-2">${element.icon}</div>NO.${numbers[0]}<div class="text-xl mt-2 text-[#5C4033] font-medium">${element.name}</div>`; }
            
            openModal(els.modalResult); soundManager.playReveal();
            setTimeout(() => burstRays.style.opacity = '1', 100);
            setTimeout(() => { resultCard.classList.add('card-enter-anim'); setTimeout(() => resultCard.classList.add('animate-float'), 800); }, 500);
            setTimeout(() => resultText.style.opacity = '1', 800);
            setTimeout(() => {
                resultNumber.style.opacity = '1'; resultNumber.classList.add('stamp-reveal');
                numbers.forEach(num => { const idx = state.grid.indexOf(num); if (idx !== -1 && !state.markedIndices.includes(idx)) state.markedIndices.push(idx); });
                if (!state.completedMissions.includes(currentMission.id)) state.completedMissions.push(currentMission.id);
                saveState(); renderGrid(); updateStats(); checkBingoLines();
                if(state.currentView === 'list') renderMissionGrid();
            }, 1500);
            setTimeout(() => { resultActions.style.opacity = '1'; closeBtn.style.pointerEvents = 'auto'; }, 2200);
        }

        document.getElementById('close-result-btn').onclick = () => { soundManager.playClick(); closeModal(els.modalResult); };
        function handleUserSelection(idx) {
            const num = state.grid[idx];
            if (confirm(`ç¢ºå®šåœ¨ä½ç½® ${idx+1} å¡«å…¥è™Ÿç¢¼ ${num} å—ï¼Ÿ`)) {
                state.markedIndices.push(idx); state.completedMissions.push(currentMission.id); state.isSelectionMode = false;
                saveState(); renderGrid(); updateStats(); fireConfetti(); checkBingoLines();
            }
        }

        loadState();
    </script>
</body>
</html>